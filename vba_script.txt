Private Declare PtrSafe Function getFrequency Lib "kernel32" Alias "QueryPerformanceFrequency" (cyFrequency As Currency) As LongPtr
Private Declare PtrSafe Function getTickCount Lib "kernel32" Alias "QueryPerformanceCounter" (cyTickCount As Currency) As LongPtr
Public Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As LongPtr) 'For 64 bit systems
Public vyhodnoceni_performance As String
Public turnovers_tenant2 As String
Public inte3() As tenant_kontrola
Public verze As String
Public kontrola_komentare_nahraj As String
Public aktivni_list As String
Public vzestupne_sestupne As String
Public vyber_jednotky_promena As String

Public Type komentare_promena
    komentare_text As String
    bunka_adresa As String
    unit_name As String
    tenant_name As String
    list As String
    komentare_zmena_datumu As String
End Type

Public Type tenant_hledej
    unit_name As String
    tenant_name As String
End Type

Public Type setrideni
    nazev_sl As String
    pozice_sl_excel As Integer
    pozice_sl_sql As Integer
    typ As Integer
    hodnota_radek As String
    rok As Double
End Type

Private Type fin_hodnoty
  vysledny_retezec As String
End Type

Public Type tenant_kontrola
    unit_name As String
    tenant_name As String
    brand_name As String
    tenant_category As String
    unit_size_sqm As Double
    opening_date As Date
    Contract_effectivity_date As Date
    contract_expiration_date As Date
    abatements_end_date As Date
End Type

Public Type faktury_kontrola
    unit_name As String
    tenant_name As String
    brand_name As String
    opening_date As Date
    contract_expiration_date As Date
    system_date As String
    actual_rent As Double
End Type

Public dTime As Double
Public stala_promena As New Collection

Sub nahravani_pilot_tenant()

frmWait.Label2 = "Tenancy schedule update process under way..."
frmWait.Show
frmWait.Repaint

Dim Field As Field
Dim sloupec As Long
Dim radek As Long
Dim inte() As setrideni
Dim inte2() As fin_hodnoty
Dim sloupce_celkem As Long
Dim rst As ADODB.Recordset
Dim hodnota As String
Dim r As Integer 'radek
Dim s As Integer 'sloupce

'kdy byla verze nahraná
verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

If ActiveSheet.Name() <> "S3 Tenancy Schedule" Then
    MsgBox "Jste na jiném listu než na S3 Tenancy Schedule, prosím oznaète správný list a spuse proceduru znovu."
Else
    Connect
    kontrola_verze
    
    If kontrola_performance("zapis", "tenant_list") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    If kontrola_posledniho_zaznamu("tenant_list") = "No" Then
        Unload frmWait
        MsgBox " Konèím bez nahrání dat na server!", vbInformation
        Exit Sub
    End If
    
    aktivni_list = ActiveSheet.Name()
    Call komentare_nahraj
    If kontrola_komentare_nahraj = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    sloupce_celkem = Cells(1, Columns.Count).End(xlToLeft).Column
    lr = Cells(Rows.Count, 2).End(xlUp).Row - 1
    
    ReDim inte(1 To sloupce_celkem) As setrideni 'poèet sloupcù v excelu
    ReDim inte2(1 To lr) As fin_hodnoty 'poèet øádek
    
    'uložení názvu sloupcù a jejich pozic
    For I = 1 To UBound(inte)
      inte(I).pozice_sl_excel = I
      inte(I).nazev_sl = Cells(1, I)
    Next I
    
    'propojení s sql
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    Set rst = New ADODB.Recordset
    sql = "SELECT * FROM tenant_list WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
    rst.Open sql, CN, adOpenStatic
    
    'ukládání sql promìných do mezipamìti
    For J = 0 To rst.Fields.Count - 1 ' j je sloupec v sql
        For I = 1 To sloupce_celkem 'i prezentuje sloupec excelu
          If rst.Fields(J).Name = inte(I).nazev_sl Then
            inte(I).pozice_sl_sql = J
            vyhodnoceni = "zapis"
            inte(I).typ = rst.Fields(J).Type
            Exit For
          End If
        Next I
        If vyhodnoceni = "" And rst.Fields(J).Name <> "(system)_datum_cas_nahrani" And rst.Fields(J).Name <> "(system)_nahrano_uctem" And rst.Fields(J).Name <> "(system)_nahravano_verzi" And rst.Fields(J).Name <> "(system)_company" And rst.Fields(J).Name <> "(system)_row" Then
            MsgBox "Chybý sloupec """ & rst.Fields(J).Name & """ prosím vyexportujte si seznam ještì jednou nebo upravte nazpátek zmìny, které jste v názvech sloupcù udìlali." & vbNewLine & vbNewLine & "Bez správných názvù sloupcù se data neodešlou.", vbCritical
            Unload frmWait
            Exit Sub
        End If
        vyhodnoceni = ""
    Next J
       
    'rst.Close
     Set rs = Nothing
     CN.Close
     Set CN = Nothing
    
    'seøazení sql dotazu pro insert - hlavièky sloupcù
    For I = 1 To sloupce_celkem - 1
        zahlavi = zahlavi & "," & inte(I).nazev_sl
    Next
    zahlavi = Mid(zahlavi, 2, Len(zahlavi) - 1)
    

    
    'naplnìní dat do promìných (po øádcích)
    For r = 2 To Cells(Rows.Count, 2).End(xlUp).Row
        J = r - 1

    ' ------------------------------------ uprava provedeni --------------------------------------------

        For s = 1 To sloupce_celkem
            If IsError(Cells(r, inte(s).pozice_sl_excel)) = False Then
                If inte(s).typ = 131 Then 'cislo
                    If Cells(r, inte(s).pozice_sl_excel) = "" Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                    ElseIf IsNumeric(Cells(r, inte(s).pozice_sl_excel)) = False Then
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox " Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " jsou textové hodnoty. Tento sloupec mùže obsahovat pouze èíselné hodnoty. Upravte podklad a puste nahrávání znovu." & vbNewLine & vbNewLine & "Data se nenahrála"
                        Unload frmWait
                        Exit Sub
                    Else
                        inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel) * 100, "#0") & "'"
                    End If
                ElseIf inte(s).typ = 201 Then 'text
                    inte(s).hodnota_radek = "'" & Cells(r, inte(s).pozice_sl_excel) & "'"
                ElseIf inte(s).typ = 133 Then 'datum
                    If IsNumeric(Format(Cells(r, inte(s).pozice_sl_excel), "#0")) = True Or Cells(r, inte(s).pozice_sl_excel) = "" Then
                        If Cells(r, inte(s).pozice_sl_excel) = "" Then
                            inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                        Else
                            inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel), "YYYY-MM-DD") & "'"
                        End If
                    Else
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " musí být datum nebo prázdné pole!" & vbNewLine & vbNewLine & "Data nenahrála na server, po opravì spuste proceduru znovu.", vbCritical
                        Unload frmWait
                        Exit Sub
                    End If
                End If
            ElseIf IsError(Cells(r, inte(s).pozice_sl_excel)) = True Then
                If inte(s).typ = 131 Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                ElseIf inte(s).typ = 201 Then
                    inte(s).hodnota_radek = "''"
                ElseIf inte(s).typ = 133 Then
                    inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                End If
            End If

            If inte(s).typ = 0 And inte(s).pozice_sl_sql = 0 And inte(s).hodnota_radek = "" Then
                inte(s).hodnota_radek = "NEVKLADAT"
            Else
                inte(s).hodnota_radek = Replace(inte(s).hodnota_radek, ",", ".")
            End If
        Next

        'složí to celé dohromady za øádku
        For s = 1 To sloupce_celkem
            If inte(s).hodnota_radek <> "NEVKLADAT" Then
                inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & "," & inte(s).hodnota_radek
            End If
        Next

        inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & ",'" & verze & "','" & Environ("UserName") & "','" & Replace(Sheets("settings").Range("A3"), ",", ".") & "','" & Sheets("settings").Range("A5") & "'"

        'opravy pro vstup do sql
        inte2(J).vysledny_retezec = Mid(inte2(J).vysledny_retezec, 2, Len(inte2(J).vysledny_retezec) - 1)
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
    Next

    For I = 1 To UBound(inte2)
        strsql = "INSERT INTO `pilot`.`tenant_list` " & " VALUES (" & inte2(I).vysledny_retezec & ",'0')"
        Set rs = CreateObject("ADODB.Recordset")
        Set CN = CreateObject("ADODB.Connection")
        CN.Open "DSN=test"
        rs.Open strsql, CN, adOpenStatic
       'rst.Close
        Set rs = Nothing
        CN.Close
        Set CN = Nothing
    Next
End If
     'zamknout jendotlivou buòku aby to tu nebylo
    
    'dohrat kontrolu jestli se data nahraly vsechny pres verzi (sql dotaz) na poèet??? jak to budu kontrolovat?
    'možná poslední záznam v sql a porovnat poslední záznam po nahrátí? tedy fce
    'èíslo na které to porovnám vemu odtud, budoucnu bude upraveno o další tabulku na zadávání tenancy nájemcù
    'až po vyjasnìní detailù
    
    'pøidat kontrolu na tenanty aby nebyli dupliciti i v rámci sloupcù (kromì brandu)...
    'napropojit turnovers
    'rozkouskovat na jednotlivé tabulky
    'pøidat novou nabídku
    'postupnì zapracovat další podklady (fin. summary)
    
    'až budou finální data pøekopírovat data z tabulky tenant_list do tenant_list final pøes sql abychom mìli tu databázi rychlou
    
    'jestli to již teï rozdìlit na jednotlivé tabulky, které se budou používat tøeba na turnovers...
    'jednotné kódy(které se budou brát napøíè všechny obchodní centra... pøes bridge bude to zajímavé???
    'tím pádem by se nahrávaly jen nìkteré informace a tøeba èíselníky by zùstali? nebo by se to rozšiøovalo podle uživatele?
    
    'kontrolu na nové jednotky provést pøi nahrání (spustí se userform)
    'zeptat se ty jsi nový - z èeho jsi vznikl rozdìlením, pøeèíslováním, sjednocením... apod. Nedat možnost si sám naèíslit(naše èíslování), jejich nechat si naèíslit jak budou chtít jen nesmí být kolize.. držet jednu øadu.
    'možná na to vytvoøit jednotnou èást userformu, díky které se budou moci jednotlivì zapsat.
    
    'kontrolovat celkové metry.... vysvìtlit navýšení nebo ponížení.... extra èást zvláš

Unload frmWait
konec_sub = 0

End Sub

Private Sub stahni_do_excelu()
Sheets("temp").Cells.Clear
frmWait.Label2 = "Tenancy schedule download process under way..."
frmWait.Show
frmWait.Repaint

Dim sloupce As Variant
Dim upravene_sloupce As Variant
Dim upravene_sloupce_temp As Variant
Dim upravene_sloupce_TS As Variant
Dim docasna_promena As uprava_dat
Dim I As Long

'If ActiveSheet.Name() <> "S3 TS - export z SQL" Then
'    MsgBox "Jste na jiném listu než na" & vbNewLine & "S3 TS - export z SQL" & vbNewLine & "prosím oznaète správný list a spuse proceduru znovu."
'Else
    
    'co to stahnout do tempu na extra list a pote to jednoduchym zpusobem upravit v bloku a teprve pa k to nakopirovat do spravneho excelu po jednotlivych sloupcich?
    'super napad lepsi a rychlejsi asi mit nebudu
    'co špatné seøazení? udìlat makro na seøazení stáhnutých dat (podle pùvodní èásti podle "unit_name" a "tenant_name"
    
    'kontrola na pøipojení do sql
    Connect
    kontrola_verze
    Call kontrola_performance("cteni", "tenant_list")

    If kontrola_performance("cteni", "tenant_list") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    kontrola_posledniho_zaznamu ("tenant_list")

    Dim rst As ADODB.Recordset
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    
    sql = "SELECT `(unit)_unit_name`,`(tenant)_tenant_name`,`(tenant)_brand_name`,`(tenant)_tenant_category`,`(tenant)_covenant_Strenght`,`(tenant)_unit_size_[sqm]`,`(tenant)_opening_date`,`(tenant)_contract_effectivity_date`,`(tenant)_contract_expiration_date`,`(tenant)_lease_period`,`(tenant)_unexpired_lease_term_[mth]`,`(payment)_basic_rent_[sqm]/[mth]`,`(payment)_currecny`,`(payment)_frequency`,`(payment)_turnover_based_rent[%]`,`(rent)_actual_[sqm]/[mth]`,`(rent)_actual[mth]`,`(rent)_actual[annual]`,`(rent)_GRI[sqm]/[mth]`,`(rent)_GRI[mth]`,`(rent)_GRI[annual]`,`(rent)_rental_status`,`(rent)_comment_with_influence_on_the_rent_etc.`,`(rent)_all_comment_with_influence_on_the_rent_etc.`,`(rent)_abatements_disc_rent[sqm]`,`(rent)_abatements_start_date`,`(rent)_abatements_end_date`,`(rent)_abatements_period[mth]`,`(rent)_abatements_total_amount`,`(sch_&_marketing)_service_charges`,`(sch_&_marketing)_payment_currency`,`(sch_&_marketing)_sch_total`,`(sch_&_marketing)_marketing_charge`,`"
    sql = sql & "(sch_&_marketing)2_payment_currency`,`(sch_&_marketing)_mch_Total`,`(indexation)_type_of_index`,`(indexation)_note`,`(indexation)_coeficient`,`(indexation)_date`,`(securities)_type`,`(securities)_amount_paid`,`(securities)_currency`,`(fit_out_contribution)_amount`,`(fit_out_contribution)_currency`,`(budget)_january`,`(budget)_february`,`(budget)_march`,`(budget)_april`,`(budget)_may`,`(budget)_june`,`(budget)_july`,`(budget)_august`,`(budget)_september`,`(budget)_october`,`(budget)_november`,`(budget)_december`,`(budget)_total` FROM pilot.`tenant_list` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`tenant_list`);"

    'MsgBox sql
    rst.Open sql, CN, adOpenStatic

    If rst.EOF = True Then
      GoTo hell
    End If

    For I = 0 To rst.Fields.Count - 1
        Sheets("Temp").Cells(1, I + 1).value = rst.Fields(I).Name
        If rst.Fields(I).Type = 133 Or rst.Fields(I).Type = 131 Or rst.Fields(I).Name = "(system)_datum_cas_nahrani" Or rst.Fields(I).Name <> "(system)_nahravano_verzi" Or rst.Fields(I).Name <> "(system)_company" Then  '133 datum, 131 cislo
            Set docasna_promena = New uprava_dat
            J = J + 1
            docasna_promena.sloupecID = "sloupec" & J
            docasna_promena.nazev_sloupce = rst.Fields(I).Name
            docasna_promena.typ_sloupce = rst.Fields(I).Type
            docasna_promena.cislo_sloupce = I + 1
            stala_promena.Add docasna_promena, docasna_promena.sloupecID
        End If
    Next I

    Sheets("Temp").Cells(2, 1).CopyFromRecordset rst

'-------------------------------- mega rychlostni uprava -----------------------------------------------------

    'pøidání desetiných míst pøes pamì
    ReDim upravene_sloupce(1 To rst.RecordCount, 0 To rst.Fields.Count - 1) As Variant 'poèet øádkù po úpravì

    For r = 1 To rst.RecordCount  'mohl bych nastavit na list ale když už je to v pamìti...
        For s = 0 To rst.Fields.Count - 1
            If stala_promena(s + 1).typ_sloupce = 131 Then 'cislo
                upravene_sloupce(r, s) = Sheets("Temp").Cells(r + 1, s + 1) / 100  'podmínka vytvoøená pouze pro turnovers datumy zde nejsou
            ElseIf stala_promena(s + 1).typ_sloupce = 133 Then 'datum
                If Sheets("Temp").Cells(r + 1, s + 1) = 0 Then
                    upravene_sloupce(r, s) = ""
                    Sheets("Temp").Cells(r + 1, s + 1) = ""
                Else
                    upravene_sloupce(r, s) = Sheets("Temp").Cells(r + 1, s + 1)
                End If
            Else
                upravene_sloupce(r, s) = Sheets("Temp").Cells(r + 1, s + 1)
            End If
        Next s
    Next r
    
    Set TheRange = Range(Sheets("Temp").Cells(2, 1), Sheets("Temp").Cells(rst.RecordCount + 1, rst.Fields.Count))  'nastavení rozsahu upravovaných dat
    TheRange.value = upravene_sloupce 'hromadna uprava cisel (pres pamet)
    
    For I = 1 To stala_promena.Count 'úprava formátù
        If stala_promena(I).typ_sloupce = 131 Then
            If stala_promena(I).nazev_sloupce = "(tenant)_unit_size_[sqm]" Or stala_promena(I).nazev_sloupce = "(rent)_actual_[sqm]/[mth]" Or stala_promena(I).nazev_sloupce = "(payment)_basic_rent_[sqm]/[mth]" Or stala_promena(I).nazev_sloupce = "(payment)_turnover_based_rent[%]" Then
                Range(Sheets("Temp").Cells(2, I), Sheets("Temp").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0.00"
            Else
                Range(Sheets("Temp").Cells(2, I), Sheets("Temp").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0"
            End If
        ElseIf stala_promena(I).typ_sloupce = 133 Then
            Range(Sheets("Temp").Cells(2, I), Sheets("Temp").Cells(rst.RecordCount + 2, I)).NumberFormat = "DD.MM.YYYY"
        End If
    Next
    
    'èištìní
    Erase upravene_sloupce
    Set docasna_promena = Nothing
    Set TheRange = Nothing
    ReDim upravene_sloupce_temp(1 To rst.RecordCount, 0 To 1) As Variant 'poèet øádkù po úpravì
    celkem_radek = rst.RecordCount
    celkem_sloupec = rst.Fields.Count
'/------------------------------- mega rychlostni uprava -----------------------------------------------------
    
    Set stala_promena = Nothing
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
'End If
hell:

'uprava dat (radky na uzivatelsky definovanou zakladnu)
For radek_uprava = 1 To celkem_radek
    upravene_sloupce_temp(radek_uprava, 0) = Sheets("temp").Cells(radek_uprava + 1, 1) & ", " & Sheets("temp").Cells(radek_uprava + 1, 2) 'projde jeden seznam s nazvem Temp
    sloupec_serazeni1 = Sheets("temp").Cells.Find(What:="(unit)_unit_name", After:=Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    sloupec_serazeni2 = Sheets("temp").Cells.Find(What:="(tenant)_tenant_name", After:=Sheets("temp").Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    radek_serazeni = Sheets("temp").Cells.Find(What:=Sheets("temp").Cells(radek_uprava + 1, 1), After:=Sheets("temp").Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Row()
    For radek_serazeni = 2 To Cells(Rows.Count, 1).End(xlUp).Row()
        If Cells(radek_serazeni, sloupec_serazeni1) & ", " & Cells(radek_serazeni, sloupec_serazeni2) = upravene_sloupce_temp(radek_uprava, 0) Then
            If upravene_sloupce_temp(radek_uprava, 1) = "" Then
                upravene_sloupce_temp(radek_uprava, 1) = radek_serazeni
            Else
                MsgBox "V tenancy Schedule máte duplicitní záznam tenanta " & vbNewLine & upravene_sloupce_temp(radek_uprava, 0) & vbNewLine & " na øádcích " & upravene_sloupce_temp(radek_uprava, 1) & ", " & radek_serazeni
                Application.Union(Rows(upravene_sloupce_temp(radek_uprava, 1)), Rows(radek_serazeni)).Select
                Unload frmWait
                Exit Sub
            End If
        End If
    Next radek_serazeni
Next

Set TheRange = Range(Sheets("Temp").Cells(2, celkem_sloupec + 2), Sheets("Temp").Cells(celkem_radek + 1, celkem_sloupec + 3)) 'nastavení rozsahu upravovaných dat
lastsloupec = celkem_sloupec + 3
TheRange.value = upravene_sloupce_temp 'hromadna uprava cisel (pres pamet)

'podívat se jestli nechybí z tempu v tenancy nìjací nájemci
'   a ZDE pøidat pak otázku proèpak chybí (jestli mìli konec nájmu nebo jestli tam byl jiný dùvod, možné rozšíøení do budoucna

'For radek_uprava = 1 To celkem_radek
'    For sedi_cislovani = 1 To celkem_radek
'
'    Next
'Next

'------------------------ kontrola jestli jsou všechny nájemci (aktualne doplnene) v seznamu stáhnutým z sql  ------------------------
posledni_zaznam_ts = Cells(Rows.Count, 1).End(xlUp).Row()

Do
    If Cells(posledni_zaznam_ts, 1) = "" Then
        posledni_zaznam_ts = posledni_zaznam_ts - 1
    Else
        Exit Do
    End If
Loop

ReDim upravene_sloupce_TS(1 To posledni_zaznam_ts - 1) As Variant   'poèet øádkù po úpravì
For radek_uprava = 1 To posledni_zaznam_ts - 1
    sloupec_serazeni1 = Cells.Find(What:="(unit)_unit_name", After:=Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    sloupec_serazeni2 = Cells.Find(What:="(tenant)_tenant_name", After:=Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    upravene_sloupce_TS(radek_uprava) = Cells(radek_uprava + 1, sloupec_serazeni1) & ", " & Cells(radek_uprava + 1, sloupec_serazeni2)
Next

For radek_uprava = 1 To posledni_zaznam_ts - 1 'uživatel zdroj
    For radek_uprava_cyklus = 1 To celkem_radek
        If upravene_sloupce_TS(radek_uprava) = upravene_sloupce_temp(radek_uprava_cyklus, 0) Then
            nasla_se_kombinace = "ok"
            Exit For
        End If
    Next radek_uprava_cyklus
    
    If nasla_se_kombinace = "ok" Then
        nasla_se_kombinace = ""
    Else
        Cells(radek_uprava + 1, sloupec_serazeni1).EntireRow.Select
        iret = MsgBox("Nájemce " & Cells(radek_uprava + 1, sloupec_serazeni1) & ", " & Cells(radek_uprava + 1, sloupec_serazeni2) & " není v seznamu tenantù v sql." & vbNewLine & vbNewLine & "Je-li aktuální seznam zastaralý a chcete nechat seznam zaktualizovat automaticky, kliknìte na:" & vbNewLine & "Ano. " & vbNewLine & vbNewLine & "Je-li seznam správnì vyplnìný a tenant by mìl být v seznamu, " & vbNewLine & "kliknìte na:" & vbNewLine & "Ne." & vbNewLine & " Stahování dat se ukonèí. Poté spuste nejprve upload pøed stáhnutím dat.", vbYesNo, "Data neodpovídají aktuálním datùm na serveru")
        If iret = vbNo Then
            Unload frmWait
            Exit Sub
        ElseIf iret = vbYes Then
            Cells(radek_uprava + 1, 1).EntireRow.Delete
            nasla_se_kombinace = ""
        End If
    End If
Next radek_uprava
'/----------------------- kontrola jestli jsou všechny nájemci (aktualne doplnene) v seznamu stáhnutým z sql  ------------------------

'------------------------------------- kontrola jestli ve starém seznamu sql nìkdo nechybí -- mohli bychom v budoucnu pøidat msgbox kde by zadávalo proè skonèil
For radek_uprava_cyklus = 1 To celkem_radek 'sql zdroj dohraj do tabulky (aktualizace nìkým jiným ... dát info o tom)
    For radek_uprava = 1 To posledni_zaznam_ts - 1
        If upravene_sloupce_TS(radek_uprava) = upravene_sloupce_temp(radek_uprava_cyklus, 0) Then
            nasla_se_kombinace = "ok"
            Exit For
        End If
    Next radek_uprava
    
    If nasla_se_kombinace = "ok" Then
        nasla_se_kombinace = ""
    Else
        'Pokud to nahrvám sám a už jsem to nahrával a najdu rozdíl v tenantu a v aktuálním souboru. Mìl by na to být uživatel upozornìn pokud to odmazával nìkdfo jiný?
        '"SELECT `(system)_nahrano_uctem`,`(system)_datum_cas_nahrani` FROM pilot.tenant_list WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list) GROUP BY `(system)_nahrano_uctem`;"
        Set rst = New ADODB.Recordset
        rst.CursorLocation = adUseClient
        Set CN = New ADODB.Connection
        CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
        sql = "SELECT `(system)_nahrano_uctem`,`(system)_datum_cas_nahrani` FROM pilot.tenant_list WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list) GROUP BY `(system)_nahrano_uctem`;"
        rst.Open sql, CN, adOpenStatic
        
        If rst.EOF = True Then
          GoTo hell
        End If
        
        nahrano_uzivatelem = rst(0).value
        datum_nahrani_uzivatelem = rst(1).value
        
        Sheets("temp").Cells(radek_uprava_cyklus + 1, 1).EntireRow.Copy
        Cells(radek_uprava_cyklus + 1, 1).Insert Shift:=xlDown
        MsgBox " Data byly doplnìny o nájemce: " & Cells(radek_uprava_cyklus + 1, 1) & ", " & Cells(radek_uprava_cyklus + 1, 2) & "." & vbNewLine & "Nájemce byl naposledy pøidán/aktualizován uživatelem " & nahrano_uzivatelem & ". " & vbNewLine & "Dne - " & datum_nahrani_uzivatelem, vbInformation
        nasla_se_kombinace = ""
    End If
Next radek_uprava_cyklus
'/------------------------------------ kontrola jestli ve starém seznamu sql nìkdo nechybí -- mohli bychom v budoucnu pøidat msgbox kde by zadávalo proè skonèil
Sheets("temp").Visible = True
posledni_bunka = Sheets("Temp").Cells.SpecialCells(xlLastCell).Address()
If Not Sheets("Temp").AutoFilterMode Then
    Sheets("Temp").Range(Sheets("Temp").Cells(1, 1), posledni_bunka).AutoFilter
Else
    Sheets("Temp").AutoFilterMode = Falsea
    Sheets("Temp").Range(Sheets("Temp").Cells(1, 1), posledni_bunka).AutoFilter
End If
    
ActiveWorkbook.Worksheets("Temp").AutoFilter.Sort.SortFields.Clear
ActiveWorkbook.Worksheets("Temp").AutoFilter.Sort.SortFields.Add Key:=Range(Cells(2, lastsloupec), Cells(radek_uprava, lastsloupec)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortTextAsNumbers
    With ActiveWorkbook.Worksheets("Temp").AutoFilter.Sort
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

'jak to upravit na sloupce asi bych si opìt vytvoøil blok pamìti? Nebo to odflákat ruènì ... stejnì to nemùžeme všechno jen pøeuložit ... a asi tak èasto se to mìnit nebude...
'co se týèe øádkù ...? co s tím jestli se pøidá øádek a já o tom nebudu vìdìt tak se mi to celé pak posune.... Možná udìlat ještì úpravu a pøidat mezery do míst, kde je èíslo vìtší než 1 na temp

'------------------opìtovná oprava po úpravách ... šlo by zkrátit do budoucna možná ještì zprocesuju---------------------------
Erase upravene_sloupce_temp
ReDim upravene_sloupce_temp(1 To celkem_radek, 0 To 1) As Variant 'poèet øádkù po úpravì, radek_uprava
'uprava dat (radku na uzivatelsky definovanou zakladnu)
For radek_uprava = 1 To celkem_radek
    upravene_sloupce_temp(radek_uprava, 0) = Sheets("temp").Cells(radek_uprava + 1, 1) & ", " & Sheets("temp").Cells(radek_uprava + 1, 2) 'projde jeden seznam s nazvem Temp
    sloupec_serazeni1 = Sheets("temp").Cells.Find(What:="(unit)_unit_name", After:=Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    sloupec_serazeni2 = Sheets("temp").Cells.Find(What:="(tenant)_tenant_name", After:=Sheets("temp").Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Column()
    radek_serazeni = Sheets("temp").Cells.Find(What:=Sheets("temp").Cells(radek_uprava + 1, 1), After:=Sheets("temp").Range("A1"), LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByColumns, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Row()
    For radek_serazeni = 2 To Cells(Rows.Count, 1).End(xlUp).Row()
        If Cells(radek_serazeni, sloupec_serazeni1) & ", " & Cells(radek_serazeni, sloupec_serazeni2) = upravene_sloupce_temp(radek_uprava, 0) Then
            If upravene_sloupce_temp(radek_uprava, 1) = "" Then
                upravene_sloupce_temp(radek_uprava, 1) = radek_serazeni
            Else
                MsgBox "V tenancy Schedule máte duplicitní záznam tenanta " & vbNewLine & upravene_sloupce_temp(radek_uprava, 0) & vbNewLine & " na øádcích " & upravene_sloupce_temp(radek_uprava, 1) & ", " & radek_serazeni
                Unload frmWait
                Exit Sub
            End If
        End If
    Next radek_serazeni
Next

Set TheRange = Range(Sheets("Temp").Cells(2, celkem_sloupec + 2), Sheets("Temp").Cells(celkem_radek + 1, celkem_sloupec + 3)) 'nastavení rozsahu upravovaných dat
lastsloupec = celkem_sloupec + 3
TheRange.value = upravene_sloupce_temp 'hromadna uprava cisel (pres pamet)
'/-----------------opìtovná oprava po úpravách ... šlo by zkrátit do budoucna možná ještì zprocesuju---------------------------

Erase upravene_sloupce_temp
Erase upravene_sloupce_TS
Set rst = Nothing
Set TheRange = Nothing

'uprava dat (sloupcù na uzivatelsky definovanou zakladnu)
'asi zkopiruju po sloupcich vsechny data, ktere potrebuju


'------------------------------------------------ kontrola duplicit ve sloupci -------------------------------------------------------------------------------------
ReDim sloupce(1 To celkem_sloupec) As Variant

For cislo_sl = 1 To celkem_sloupec 'definovano uzivatelem TS
    sloupce(cislo_sl) = Sheets("temp").Cells(1, cislo_sl)
Next

For cislo_sl = 1 To celkem_sloupec 'definice jestli je nebo neni stejny sloupec v excelu
    With Range("1:1")
        Set c = .Find(sloupce(cislo_sl), LookIn:=xlValues)
        If Not c Is Nothing Then
            firstaddress = c.Column
            Do
                Set c = .FindNext(c)
                If c.Column = firstaddress Then
                    Exit Do
                Else
                    MsgBox "V Tenancy máte více sloupcù s názvem: " & c.value & ". Pùvodní názvy sloupcù prosím nepøepisujte. Nové názvy sloupcù pojmenujte rozdílnì." & vbNewLine & vbNewLine & "Data se nezaktualizovali." & vbNewLine & "Oprvate název na pùvodní a spuste stahování dat znovu." & vbNewLine & vbNewLine & "Jde o sloupce: " & Split(Cells(1, firstaddress).Address(1, 0), "$")(0) & " a " & Split(Cells(1, c.Column).Address(1, 0), "$")(0)  'Split(ActiveCell.Address(1, 0), "$")(0)
                    Application.Union(Columns(c.Column), Columns(firstaddress)).Select
                    Unload frmWait
                    Exit Sub
                End If
            Loop 'While Not c Is Nothing And c.Column <> firstaddress
            
            If firstaddress <> c.Column Then
                MsgBox "V Tenancy máte více sloupcù s názvem: " & c.value & ". Pùvodní názvy sloupcù prosím nepøepisujte. Nové názvy sloupcù pojmenujte rozdílnì." & vbNewLine & vbNewLine & "Data se nezaktualizovali." & vbNewLine & "Oprvate název na pùvodní a spuste stahování dat znovu." & vbNewLine & vbNewLine & "Jde o sloupce: " & Split(Cells(1, firstaddress).Address(1, 0), "$")(0) & " a " & Split(Cells(1, cislo_sl).Address(1, 0), "$")(0)  'Split(ActiveCell.Address(1, 0), "$")(0)
                Unload frmWait
                Exit Sub
            ElseIf c.Column <> cislo_sl Then
               a = a
            End If
        Else
            MsgBox "Upravili jste název sloupce: " & sloupce(cislo_sl) & ". Nepøepisujte pùvodní názvy sloupcù. Oprvate název na pùvodní a spuste stahování dat znovu."
            Unload frmWait
            Exit Sub
        End If
    End With
Next
'/----------------------------------------------- kontrola duplicit ve sloupci -------------------------------------------------------------------------------------

'uprava sloupcu (nahravani do pameti a vykopirovani opetovne ven)

'uložit pøes redim do pamìti a pak vykopírovat ven do správného sloupce ... u prázdných buòek se podívat do pùvodního listu jestli tam není nìjaká poznámka?

Sheets("S3 Tenancy Schedule").Cells.ClearContents
Sheets("temp").Visible = True
Sheets("Temp").Select
Range(Cells(1, 1), Range(ActiveCell.SpecialCells(xlLastCell).Address)).Copy
Sheets("S3 Tenancy Schedule").Select
Cells(1, 1).PasteSpecial
Sheets("temp").Cells.Clear
Sheets("temp").Visible = xlVeryHidden
Range("A1").Select

Call komentare_stahni_do_excelu

Unload frmWait
konec_sub = 0
End Sub



Sub nahraj_turnovers()

Dim MyVal As String

frmWait.Label2 = "Turnovers update process under way..."
frmWait.Show
frmWait.Repaint

Dim message As Integer
Dim Field As Field
Dim sloupec As Long
Dim radek As Long
Dim inte4() As setrideni
Dim inte2() As fin_hodnoty
Dim sloupce_celkem As Long
Dim hodnota As String
Dim r As Integer 'radek
Dim s As Integer 'sloupce

kontrola_komentare_nahraj = ""

verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

If ActiveSheet.Name() <> "S5 Turnovers" Then
    MsgBox "Jste na jiném listu než na S5 Turnovers, prosím oznaète správný list a spuse proceduru znovu."
Else
    Connect
    kontrola_verze
    
    If kontrola_performance("zapis", "turnovers") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    If kontrola_posledniho_zaznamu("turnovers") = "No" Then
        Unload frmWait
        MsgBox " Konèím bez nahrání dat na server!", vbInformation
        Exit Sub
    End If
    
    aktivni_list = ActiveSheet.Name()
    Call komentare_nahraj
    If kontrola_komentare_nahraj = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
'    If kontrola_tenancy("turnovers") = "No" Then
'        turnovers_tenant_odkaz = Cells(r, inte4(s).pozice_sl_excel).Address
'        Range(turnovers_tenant_odkaz).EntireRow.Select
'        Unload frmWait
'        Select Case MsgBox("Nemáte správnì název firmy " & turnovers_tenant & " , nebo nemáte k tenatovi pøiøazený správný unit kód " & turnovers_unit & "." & vbNewLine & "Firma se nedaøí dohledat v listu Tenantcy_schedule" & vbNewLine & vbNewLine & "Pokud chcete nechat nájemce v seznamu i pøes to, že v tenancy neexistuje, dejte ano v opaèném pøípadì dejte ne a nájemce odmažte ze seznamu. Poté znovu spuste.", vbYesNo)
'            Case vbNo
'                Unload frmWait
'                Exit Sub
'        End Select
'
'    End If
    
    'jak budu ukladat vic dat tak abych nebral duplicity... toto maly sql dotazek doda spravne grady
    Dim rst As ADODB.Recordset
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT COUNT(`(unit)_unit_name`) 'pocet_promenych' FROM tenant_list WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list)"
    rst.Open sql, CN, adOpenStatic, adLockReadOnly
        pocet_radek_rst = rst(0).value
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing

'vlož do pamìti vše z tenantù (co se bude nahrávat) samo že z sql
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT `(unit)_unit_name`, `(tenant)_tenant_name`, `(tenant)_brand_name`, `(tenant)_tenant_category`, `(tenant)_unit_size_[sqm]`, `(tenant)_opening_date`, `(tenant)_contract_effectivity_date`, `(tenant)_contract_expiration_date`, `(rent)_abatements_end_date` FROM pilot.`tenant_list` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list)"
    
        'ještì se musí pøidat where a poslední záznam abych nenaèítal šílený seznam
    rst.Open sql, CN, adOpenStatic, adLockReadOnly
    ReDim inte3(1 To pocet_radek_rst) As tenant_kontrola 'vytvoøí poèet promìných až
    
    If inte3(26).unit_name = "K.A.048" Then
        a = a
    End If
    
    For J = 0 To pocet_radek_rst - 1
        For I = 0 To rst.Fields.Count - 1
            Select Case I + 1
                Case 1
                    inte3(J + 1).unit_name = rst(I).value 'ukladani do radku
                Case 2
                    inte3(J + 1).tenant_name = rst(I).value 'ukladani do radku
                Case 3
                    inte3(J + 1).brand_name = rst(I).value 'ukladani do radku
                Case 4
                    inte3(J + 1).tenant_category = rst(I).value 'ukladani do radku
                Case 5
                    inte3(J + 1).unit_size_sqm = rst(I).value  'ukladani do radku
                Case 6
                    inte3(J + 1).opening_date = rst(I).value  'ukladani do radku
                Case 7
                    inte3(J + 1).Contract_effectivity_date = rst(I).value  'ukladani do radku
                Case 8
                    inte3(J + 1).contract_expiration_date = rst(I).value  'ukladani do radku
                Case 9
                    inte3(J + 1).abatements_end_date = rst(I).value  'ukladani do radku
            End Select
        Next I
        rst.MoveNext
    Next J

    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing

sloupce_celkem = Cells(2, Columns.Count).End(xlToLeft).Column 'možná udìlat usedrange
ReDim inte4(1 To sloupce_celkem) As setrideni

'uložení názvu sloupcù a jejich pozic
For I = 1 To UBound(inte4)
    inte4(I).pozice_sl_excel = I
    '-------------------------------------------------kontrola, že žádný sloupec není pojmenovaný od 1 do 12ctky-------------------------------------------------
        If IsNumeric(Cells(2, I)) = True And Cells(2, I) >= 1 And Cells(2, I) <= 12 Then
            MsgBox "V reportu se vyskytuje sloupec s èíselnýn názvem od 1 až 12 v záhlaví." & vbNewLine & "Pro správnou funkcionalitu reportu,nemùže být takto sloupec nazván. Pøejmenujte ho a spuse makro znovu."
            Cells(2, I).Select
            Unload frmWait
            Exit Sub
        End If
    '/------------------------------------------------kontrola, že žádný sloupec není pojmenovaný od 1 do 12ctky-------------------------------------------------
    inte4(I).nazev_sl = Cells(2, I)
    If Cells(2, I) = "JANUARY" Then
        oblast = Cells(1, I).Address()
        If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
            inte4(I).rok = Year(Now())
        ElseIf Cells(2, I) <> "TOTAL" Then
            inte4(I).rok = Range(oblast)
        End If
        prvni_leden = 1
    ElseIf prvni_leden = 1 Then
        Select Case Cells(2, I)
            Case "JANUARY"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "FEBRUARY"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "MARCH"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "APRIL"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "MAY"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "JUNE"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "JULY"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "AUGUST"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "SEPTEMBER"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "OCTOBER"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "NOVEMBER"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case "DECEMBER"
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
        End Select
    End If
Next I

'zmìním názvy mìsícù na èísla
For I = 1 To UBound(inte4)
Select Case inte4(I).nazev_sl
    Case "JANUARY"
        inte4(I).nazev_sl = 1
    Case "FEBRUARY"
        inte4(I).nazev_sl = 2
    Case "MARCH"
        inte4(I).nazev_sl = 3
    Case "APRIL"
        inte4(I).nazev_sl = 4
    Case "MAY"
        inte4(I).nazev_sl = 5
    Case "JUNE"
        inte4(I).nazev_sl = 6
    Case "JULY"
        inte4(I).nazev_sl = 7
    Case "AUGUST"
        inte4(I).nazev_sl = 8
    Case "SEPTEMBER"
        inte4(I).nazev_sl = 9
    Case "OCTOBER"
        inte4(I).nazev_sl = 10
    Case "NOVEMBER"
        inte4(I).nazev_sl = 11
    Case "DECEMBER"
        inte4(I).nazev_sl = 12
End Select
Next

'propojení s sql
Set CN = New ADODB.Connection
CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
Set rst = New ADODB.Recordset
sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
rst.Open sql, CN, adOpenStatic

'ukládání sql promìných do mezipamìti
For J = 0 To rst.Fields.Count - 1
    If rst.Fields(J).Name <> "(system)_radek" Then
        nazvy_sloucu = nazvy_sloucu & ",`" & rst.Fields(J).Name & "`"
    End If
    For I = 1 To sloupce_celkem
      If rst.Fields(J).Name = inte4(I).nazev_sl Or (rst.Fields(J).Name = "Year" And inte4(I).nazev_sl = "1") Then
        inte4(I).pozice_sl_sql = J
        vyhodnoceni = inte4(I).pozice_sl_sql
        inte4(I).typ = rst.Fields(J).Type ' definice typu promìné
        Exit For
      End If
    Next I
    If vyhodnoceni = "" Or rst.Fields(J).Name <> "(system)_datum_cas_nahrani" Or rst.Fields(J).Name <> "(system)_nahrano_uctem" Or rst.Fields(J).Name <> "(system)_nahravano_verzi" Or rst.Fields(J).Name <> "(system)_radek" Or rst.Fields(J).Name <> "(system)_company" Or rst.Fields(J).Name <> "Year" Then
        Else
        MsgBox "Chybý sloupec """ & rst.Fields(J).Name & """ prosím vyexportujte si seznam ještì jednou nebo upravte nazpátek zmìny, které jste v názvech sloupcù udìlali." & vbNewLine & vbNewLine & "Bez správných názvù sloupcù se data neodešlou.", vbCritical
        Exit Sub
    End If
    vyhodnoceni = ""
Next J

    nazvy_sloucu = Mid(nazvy_sloucu, 2, Len(nazvy_sloucu) - 1)

'samoopravny kod, hlida abych mel doplnen vsechny casti ,dohrat do promenych na zbytek let pozice sql (pùvodnì se pøedpokládalo, že nebudou duplicity ve sloupcích - odlišeno rokem)
For I = 1 To sloupce_celkem
    If inte4(I).pozice_sl_sql <> 0 Then
        mesic = inte4(I).nazev_sl
        typ = inte4(I).typ
        temp_pozice = inte4(I).pozice_sl_sql
        If IsNumeric(mesic) = True Then
            For J = 1 To sloupce_celkem
                If inte4(J).pozice_sl_sql = 0 And inte4(J).nazev_sl = mesic Then
                    inte4(J).pozice_sl_sql = temp_pozice
                    inte4(J).typ = typ
                End If
            Next J
        End If
    End If
Next I

'rst.Close
 Set rs = Nothing
 CN.Close
 Set CN = Nothing

'kdy byla verze nahraná
'verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

'zjisti nejnovejsi rok a odecti od posledniho vysledek znasob na poctu mist? mohlo by se stat, ze nenahraje cely rok?
For I = 1 To UBound(inte4)
    If nejvetsi_rok < inte4(I).rok Or nejvetsi_rok = "" Then
        nejvetsi_rok = inte4(I).rok
    End If
    
    If nejmensi_rok > inte4(I).rok Or nejmensi_rok = 0 Then
        If inte4(I).rok > 0 Then
            nejmensi_rok = inte4(I).rok
        End If
    End If
Next I

lr_puvodni = (Cells(Rows.Count, 4).End(xlUp).Row - 2)
lr = (Cells(Rows.Count, 3).End(xlUp).Row - 2) * (nejvetsi_rok - nejmensi_rok + 1) 'upravit aby tam byla chytrá podmínka (až budu definovat export tak nastavím)

ReDim inte2(1 To lr) As fin_hodnoty

For rocni_obdobi = nejmensi_rok To nejvetsi_rok

    If inte2_cislo = UBound(inte2) Then
        Exit For
    End If
    
    For r = 3 To Cells(Rows.Count, 2).End(xlUp).Row 'pøes všechny øádky najdi øetìžce
    If inte2_cislo = 159 Then
        a = a
    End If
        If Mid(((inte2_cislo) / lr_puvodni) * 10000, 2, 10000) = 0 Then  'pokud dosáhneš na konec roèní øady, zaèni novou
            If vyhodnoceni_roku = 1 Then
                vyhodnoceni_roku = 0
            Else
                vyhodnoceni_roku = 1
                Exit For
            End If
        End If
        J = r - 1
    'tady pokraèovat
    ' ------------------------------------ uprava provedeni --------------------------------------------
    
        'do inte4 (sloupcovych hodnot, nahraju dalsi radek pro pripraveni exportu
        For s = 1 To sloupce_celkem
            If IsError(Cells(r, inte4(s).pozice_sl_excel)) = False Then
                If inte4(s).typ = 131 Then 'cislo
                    If IsNumeric(Cells(r, inte4(s).pozice_sl_excel)) = False Then
                        Cells(r, inte4(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Mid(Range(turnovers_tenant_odkaz).Address(1, 0), 1, InStr(Range(turnovers_tenant_odkaz).Address(1, 0), "$") - 1) & " mohou být pouze èísla." & vbNewLine & "Data v sloupci upravte a poté spuste znovu."
                        Unload frmWait
                        MsgBox " Konèím bez nahrání dat na server!", vbInformation
                        Exit Sub
                    ElseIf Cells(r, inte4(s).pozice_sl_excel) = "" Then
                        inte4(s).hodnota_radek = "'" & 0 & "'"
                    Else
                        inte4(s).hodnota_radek = "'" & Format(Cells(r, inte4(s).pozice_sl_excel) * 100, "#0") & "'"
                    End If
                    
                    'dohledani posledniho zapisu v mesici
                    If inte4(s).rok = nejvetsi_rok Then
                        If posledni_zapsany_mesic <= inte4(s).nazev_sl And inte4(s).hodnota_radek <> "'0'" Then
                            posledni_zapsany_mesic = inte4(s).nazev_sl
                        End If
                    End If
                ElseIf inte4(s).typ = 201 Then 'text
                    inte4(s).hodnota_radek = "'" & Cells(r, inte4(s).pozice_sl_excel) & "'"
                ElseIf inte4(s).typ = 133 Then 'datum
                    If IsNumeric(Format(Cells(r, inte4(s).pozice_sl_excel), "#0")) = True Or Cells(r, inte4(s).pozice_sl_excel) = "" Then
                        If Cells(r, inte4(s).pozice_sl_excel) = "" Then
                            inte4(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                        Else
                            inte4(s).hodnota_radek = "'" & Format(Cells(r, inte4(s).pozice_sl_excel), "YYYY-MM-DD") & "'"
                        End If
                    Else
                        Cells(r, inte4(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Cells(1, inte4(s).pozice_sl_excel) & " musí být datum nebo prázdné pole!" & vbNewLine & vbNewLine & "Data nenahrála na server, po opravì spuste proceduru znovu.", vbCritical
                        Exit Sub
                    End If
                End If
            ElseIf IsError(Cells(r, inte4(s).pozice_sl_excel)) = True Then
                If inte4(s).typ = 131 Then
                        inte4(s).hodnota_radek = "'" & 0 & "'"
                ElseIf inte4(s).typ = 201 Then
                    inte4(s).hodnota_radek = "''"
                ElseIf inte4(s).typ = 133 Then
                    inte4(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                End If
            End If
            
            If inte4(s).typ = 0 And inte4(s).pozice_sl_sql = 0 And inte4(s).hodnota_radek = "" Then
                inte4(s).hodnota_radek = "NEVKLADAT"
            Else
                inte4(s).hodnota_radek = Replace(inte4(s).hodnota_radek, ",", ".")
            End If
        Next
        '/---------------------------------------------------- tvorba --------------------------------------------------------------
        
        
        'sloupce inte4 - kontrola na tenancy - nazev a unit
        For s = 1 To sloupce_celkem
            If inte4(s).nazev_sl = "(tenant)_tenant_name" Then
                turnovers_tenant = inte4(s).hodnota_radek
                turnovers_tenant_odkaz = Cells(r, inte4(s).pozice_sl_excel).Address
                If turnovers_tenant <> "" And turnovers_unit <> "" Then Exit For
            End If
            
            If inte4(s).nazev_sl = "(unit)_unit_name" Then
                turnovers_unit = inte4(s).hodnota_radek
                If turnovers_tenant <> "" And turnovers_unit <> "" Then Exit For
            End If
        Next s
        
        turnovers_tenant = Replace(turnovers_tenant, "'", "")
        turnovers_unit = Replace(turnovers_unit, "'", "")
        
        'radky inte3 - kontrola jestli se najde radek se spravnou kombinaci
        For I = 1 To UBound(inte3)
            If inte3(I).tenant_name = turnovers_tenant And inte3(I).unit_name = turnovers_unit Then
                kontrola_nazev = "ok"
                Exit For
            End If
        Next I
        
        'kontrola datumu
        For I = 1 To UBound(inte3)
            If inte3(I).abatements_end_date <> 0 Then
                If inte3(I).contract_expiration_date > inte3(I).opening_date And inte3(I).abatements_end_date > inte3(I).opening_date And inte3(I).abatements_end_date < Now Then
                    kontrola_datumy = "ok"
                    Exit For
                End If
            Else
                If inte3(I).contract_expiration_date > inte3(I).opening_date And inte3(I).contract_expiration_date > Now Then
                    kontrola_datumy = "ok"
                    Exit For
                End If
            End If
        Next I
        
        If kontrola_nazev = "" Then
            a = a
        End If
        
        If kontrola_nazev <> "ok" Or kontrola_datumy <> "ok" Then
            
            Set rst = New ADODB.Recordset
            rst.CursorLocation = adUseClient
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            sql = "SELECT `" & posledni_zapsany_mesic & "` FROM turnovers WHERE `year` = " & nejvetsi_rok & " AND `(unit)_unit_name`='" & turnovers_unit & "' AND `(tenant)_tenant_name` = '" & turnovers_tenant & "' AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.turnovers)"
            rst.Open sql, CN, adOpenStatic
            If rst.EOF = True Then
                posledni_mesic = "nic"
            Else
                posledni_mesic = rst(0).value
            End If
            
            rst.Close
            CN.Close
            Set CN = Nothing
            
            If posledni_mesic = 0 Then
                'nájemce již není veden v tenancy ponìvadž již spoleènost není nadále nájemcem.
            Else
                'nájemce není v tenancy a i pøes to generuje stále obrat je to takto v poøádku?
                Range(turnovers_tenant_odkaz).EntireRow.Select
                Select Case MsgBox("Název firmy " & turnovers_tenant & ", která užívá jednotku " & turnovers_unit & " není v seznamu tenantù. Turnovers by tedy nemìl obsahovat obrat za aktuální období." & vbNewLine & vbNewLine & "Pokud jste pøesvìdèeni o správnosti a jde pouze o špatný název nájemce (rozdíly v diakritice apod.), dejte ano v opaèném pøípadì dejte ne a nájemce nejdøíve pøidejte do seznamu tenantù. Poté znovu spuste.", vbYesNo)
                    Case vbNo
                        Unload frmWait
                        Exit Sub
                    Case vbYes
                       'Vyber_firmu.Show
                        MyVal = turnovers_tenant
                        Vyber_firmu.MyVariable MyVal
                        Vyber_firmu.Repaint
                        'zpetne rozklicovani
                        If turnovers_tenant <> turnovers_tenant2 Then
                            For I = 1 To UBound(inte3)
                                If InStr(1, turnovers_tenant2, inte3(I).tenant_name) > 0 Then
                                    Range(turnovers_tenant_odkaz) = inte3(I).tenant_name
                                    Range(turnovers_tenant_odkaz).Offset(0, -3) = inte3(I).unit_name
                                End If
                            Next I
                            'Range(turnovers_tenant_odkaz) = Mid(turnovers_tenant2, InStr(1, turnovers_tenant2, turnovers_tenant), Len(turnovers_tenant) + 1)
                        End If
                        turnovers_tenant2 = ""
                        MsgBox "Nájemce byl doplnìn, pro nahrání dat na server spuste upload znovu!"
                        Unload frmWait
                        MsgBox " Konèím bez nahrání dat na server!", vbInformation
                        Exit Sub
                        '/zpetne rozklicovani
'                        MyVal = turnovers_tenant
'                        Vyber_firmu.MyVariable MyVal
'                        Vyber_firmu(inte3.tenant_kontrola).Show
'                        End With
'                        Vyber_firmu.MyVariable tenant_kontrola
                End Select
            End If
        End If
        
        '-------------------------------------------------------------------------------------------------------------------------------------------------------------

        '/------------------------------------------------------------------------------------------------------------------------------------------------------------
        
        'vycisteni na dalsi cyklus
        kontrola_nazev = ""
        kontrola_datumy = ""
        turnovers_tenant = ""
        turnovers_unit = ""
        '/kontrola na tenant list jestli je vše jak má být
        
        
        For s = 1 To sloupce_celkem
        'kontrola ze nezapisuju stejne stejna cisla
            
            If akt_mesic = 12 Then
                akt_mesic = 0
                Exit For
            End If
            
            'musim pøidat cyklus, který po každém zapsání projede všechno znovu ... to vše :) a i si nechá v pamìti i po skonèení cyklu
            For iii = 1 To UBound(inte4)
               'If inte4(iii).rok <> 0 And rok_vyhodnoceni = 0 And inte4(iii).rok = rocni_obdobi Then
                If inte4(iii).rok = rocni_obdobi Then
                    rok_vyhodnoceni = inte4(iii).rok
                    If I <> "" Then Exit For
                End If
                
                If s = inte4(iii).pozice_sl_sql Or s = 6 Then ' beru od jednicky do .... srovnani dat stejne jako v sql
                    If s = 6 Then
                        I = s
                    Else
                        I = iii
                    End If
                    If rok_vyhodnoceni <> 0 Then Exit For
                End If
            Next iii
            
            If I = "" Then
                If inte4(s).rok = rocni_obdobi Then 'ošetøení sloupce s rokem v sql - mohlo by dìlat potíže
                    I = inte4(s).pozice_sl_excel
                ElseIf inte4(s).rok <> rocni_obdobi Then
                    Exit For
                End If
            End If
            
            If inte4(I).hodnota_radek <> "NEVKLADAT" Then
                If inte4(I).pozice_sl_sql = 7 Then
                    If (rocni_obdobi - nejmensi_rok + 1) > 1 Then 'jde o první rok nebo je to již další rok?
                        Do
                            If inte4(I).rok = rocni_obdobi Then
                                Exit Do
                            Else
                                I = I + 1
                                If I >= UBound(inte4) Then
                                    Exit For
                                End If
                            End If
                        Loop
                        If akt_mesic = 0 Then
                            vysledny_retezec = vysledny_retezec & ",'" & inte4(I).rok & "'"
                            vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                            podminka_rok = inte4(I).rok
                            akt_mesic = 1
                        End If
                    Else 'jde o první rok
                        If akt_mesic = 0 Then
                            vysledny_retezec = vysledny_retezec & ",'" & inte4(I).rok & "'"
                            vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                            podminka_rok = inte4(I).rok
                            akt_mesic = 1
                        End If
                    End If
               Else
                    If inte4(I).rok <> 0 Or IsNumeric(inte4(I).nazev_sl) = True Then  'další rok, aktuální sloupec je již mìsíc
                        Do
                            If inte4(I).rok = rocni_obdobi And inte4(I).nazev_sl = akt_mesic + 1 Then
                                Exit Do
                            Else
                                I = I + 1
                            End If
                        Loop
                        vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                        akt_mesic = akt_mesic + 1
                    Else
                        vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                    End If
               End If
            End If
            I = "" 'smazani promene
dalsi:
        Next
        akt_mesic = 0
        inte2_cislo = inte2_cislo + 1
        I = "" 'smazani promene
        rok_vyhodnoceni = 0
        
        If neukladej = 0 Then
            inte2(inte2_cislo).vysledny_retezec = vysledny_retezec & ",'" & verze & "','" & Environ("UserName") & "','" & Replace(Sheets("settings").Range("A3"), ",", ".") & "','" & "Laugaricio'"
            vysledny_retezec = ""
        
            'opravy pro vstup do sql
            inte2(inte2_cislo).vysledny_retezec = Mid(inte2(inte2_cislo).vysledny_retezec, 2, Len(inte2(inte2_cislo).vysledny_retezec) - 1)
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",,", ",',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",,", ",',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",',", ",'',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",',", ",'',")
            
        End If
        neukladej = 0
        If inte2_cislo = 159 Then
            a = a
        End If
        
        If inte2_cislo >= UBound(inte2) Then
            Exit For
        End If
    Next
    
   'jestli jsou již všechny øádky vyøešené pak vyskoè
    If inte2_cislo = UBound(inte2) Then
        Exit For
    End If
vyhodnoceni_roku = 1
Next rocni_obdobi

For I = 1 To UBound(inte2)
    strsql = "INSERT INTO `pilot`.`turnovers` (" & nazvy_sloucu & ") VALUES (" & inte2(I).vysledny_retezec & ")"
    Set rs = CreateObject("ADODB.Recordset")
    Set CN = CreateObject("ADODB.Connection")
    CN.Open "DSN=test"
    rs.Open strsql, CN, adOpenStatic
   'rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
Next

hell:
End If

'kontrola unit_name a tenant_name na tenant list kde bych mel najit vsechno s tenancy listem, kdyby ne dat msgbox a nechat rozhodnout
'to same udelat v excelu a zkontrolovat i duplicity aby tam nebyly
'u sqm koukat jestli se nepøidali nebo neubrali a upozornit na to.
'mít další promìnou na to, že to bylo nebo nebylo vyhodnoceno, (podmínky vstupu turnovers)
'pak složit seznam, nových a vyhozených firem?
'kontrola turnovers celkových metrù na tenant list

Unload frmWait
konec_sub = 0

End Sub


Private Sub turnovers_stahni_do_excelu()
Dim rst As ADODB.Recordset
Dim rok_min As Double, rok_max As Double

frmWait.Label2 = "Turnovers download process under way..."
frmWait.Show
frmWait.Repaint

Dim docasna_promena As uprava_dat
Dim I As Long

'If ActiveSheet.Name() <> "S5 Turnovers - epoxrt z SQL" Then
'    MsgBox "Jste na jiném listu než na" & vbNewLine & "S5 Turnovers - export z SQL" & vbNewLine & "prosím oznaète správný list a spuse proceduru znovu."
'Else

    'kontrola na pøipojení do sql
    Connect
    kontrola_verze
   'kontrola_posledniho_zaznamu ("turnovers")
    
    If kontrola_performance("cteni", "turnovers") = "No" Then
        Unload frmWait
        Exit Sub
    End If

    '-definice roku
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT MAX(`year`) FROM pilot.`turnovers`;"
    rst.Open sql, CN, adOpenStatic

    If rst.EOF = True Then
      GoTo hell
    End If

    rok_max = rst(0).value

    rst.Close
    CN.Close
    Set CN = Nothing

    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT MIN(`year`) FROM pilot.`turnovers`;"
    rst.Open sql, CN, adOpenStatic
    
    If rst.EOF = True Then
      GoTo hell
    End If
    
    rok_min = rst(0).value
    
    rst.Close
    CN.Close
    Set CN = Nothing
    
    '/definice roku
    
'    'vypis pouze 3 roky
'    Do
'        If rok_min < rok_max - 2 Then
'            rok_min = rok_min + 1
'        Else
'            Exit Do
'        End If
'    Loop
    
    Select Case (rok_max - rok_min)

'    vos5 = vos4 + pocet_sloupcu
'    pocet_sloupcu = 0
'    sql_sloupce = ""
'
'    For j = 0 To rst.Fields.Count - 1
'        If IsNumeric(rst.Fields(j).Name) = True And InStr(1, rst.Fields(j).Name, "Year") = 0 Then
'            If vos5_rok = 0 Then vos5_rok = vos5
'            sql_sloupce = sql_sloupce & ",`" & rst.Fields(j).Name & "`"
'        End If
'    Next j

        Case Is = 5 'historie 5 let
            pripad = "6 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu
                End If
                
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"

            vos5 = vos4 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos5_rok = 0 Then vos5_rok = vos5
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
        
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql5 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 4 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"

            vos6 = vos5 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos6_rok = 0 Then vos6_rok = vos6
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J

            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql6 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 5 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"

            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing

        Case Is = 4 'historie 5 let
            pripad = "5 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu
                End If
                
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"

            vos5 = vos4 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos5_rok = 0 Then vos5_rok = vos5
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
        
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql5 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 4 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"

            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
            
        Case Is = 3 'historie 4 let
            pripad = "4 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu
                End If
                
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
            
        Case Is = 2 'mám historii 3 let
            pripad = "3 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu
                End If
                
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_max & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
        Case Is = 1
            pripad = "2 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu
                End If
                
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
           
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = pocet_sloupcu + vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
        Case Is = 0
            pripad = "1 rok"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`turnovers` WHERE `Year` = " & rok_max & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`turnovers`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
    End Select

    If Mid(pripad, 1, 1) = 6 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_turnovers_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_turnovers_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_turnovers_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
        Call download_turnovers_into_sheet(sql5, vos5, vos5_rok, rok_min + 4, rok_max)
        Call download_turnovers_into_sheet(sql6, vos6, vos6_rok, rok_min + 5, rok_max)
    ElseIf Mid(pripad, 1, 1) = 5 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_turnovers_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_turnovers_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_turnovers_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
        Call download_turnovers_into_sheet(sql5, vos5, vos5_rok, rok_min + 4, rok_max)
    ElseIf Mid(pripad, 1, 1) = 4 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_turnovers_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_turnovers_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_turnovers_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
    ElseIf Mid(pripad, 1, 1) = 3 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_turnovers_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_turnovers_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
    ElseIf Mid(pripad, 1, 1) = 2 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_turnovers_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
    ElseIf Mid(pripad, 1, 1) = 1 Then
        Call download_turnovers_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
    End If

'End If
hell:

Call komentare_stahni_do_excelu

Unload frmWait
konec_sub = 0

'ReDim Preserve ArrayTest(UBound(ArrayTest) + 1)

End Sub


Sub RangeTimer()
    DoCalcTimer 1
End Sub
Sub SheetTimer()
    DoCalcTimer 2
End Sub
Sub RecalcTimer()
    DoCalcTimer 3
End Sub
Sub FullcalcTimer()
    DoCalcTimer 4
End Sub

Sub DoCalcTimer(jMethod As Long)

    Dim dOvhd As Double
    Dim oRng As Range
    Dim oCell As Range
    Dim oArrRange As Range
    Dim sCalcType As String
    Dim lCalcSave As Long
    Dim bIterSave As Boolean
    '
    On Error GoTo Errhandl

' Initialize
    dTime = MicroTimer

    ' Save calculation settings.
    lCalcSave = Application.Calculation
    bIterSave = Application.Iteration
    If Application.Calculation <> xlCalculationManual Then
        Application.Calculation = xlCalculationManual
    End If
    Select Case jMethod
    Case 1

        ' Switch off iteration.

        If Application.Iteration <> False Then
            Application.Iteration = False
        End If
        
        ' Max is used range.

        If Selection.Count > 1000 Then
            Set oRng = Intersect(Selection, Selection.Parent.UsedRange)
        Else
            Set oRng = Selection
        End If

        ' Include array cells outside selection.

        For Each oCell In oRng
            If oCell.HasArray Then
                If oArrRange Is Nothing Then
                    Set oArrRange = oCell.CurrentArray
                End If
                If Intersect(oCell, oArrRange) Is Nothing Then
                    Set oArrRange = oCell.CurrentArray
                    Set oRng = Union(oRng, oArrRange)
                End If
            End If
        Next oCell

        sCalcType = "Calculate " & CStr(oRng.Count) & _
            " Cell(s) in Selected Range: "
    Case 2
        sCalcType = "Recalculate Sheet " & ActiveSheet.Name & ": "
    Case 3
        sCalcType = "Recalculate open workbooks: "
    Case 4
        sCalcType = "Full Calculate open workbooks: "
    End Select

' Get start time.
    dTime = MicroTimer
    Select Case jMethod
    Case 1
        If Val(Application.Version) >= 12 Then
            oRng.CalculateRowMajorOrder
        Else
            oRng.Calculate
        End If
    Case 2
        ActiveSheet.Calculate
    Case 3
        Application.Calculate
    Case 4
        Application.CalculateFull
    End Select

' Calculate duration.
    dTime = MicroTimer - dTime
    On Error GoTo 0

    dTime = Round(dTime, 5)
   'MsgBox sCalcType & " " & CStr(dTime) & " Seconds", vbOKOnly, vbInformation, "CalcTimer"

Finish:

    ' Restore calculation settings.
    If Application.Calculation <> lCalcSave Then
         Application.Calculation = lCalcSave
    End If
    If Application.Iteration <> bIterSave Then
         Application.Calculation = bIterSave
    End If
    Exit Sub
Errhandl:
    On Error GoTo 0
    MsgBox "Unable to Calculate " & sCalcType, _
        vbOKOnly + vbCritical, "CalcTimer"
    GoTo Finish
End Sub

Sub nahraj_rent_schedule()

frmWait.Label2 = "Rent schedule update process under way..."
frmWait.Show
frmWait.Repaint

Dim Field As Field
Dim sloupec As Long
Dim radek As Long
Dim inte4() As setrideni
Dim inte2() As fin_hodnoty
Dim inte3() As tenant_kontrola
Dim sloupce_celkem As Long
Dim hodnota As String
Dim r As Integer 'radek
Dim s As Integer 'sloupce

verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

    kontrola_komentare_nahraj = ""
    Connect
    kontrola_verze
    
    If kontrola_performance("zapis", "rent_schedule") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    If kontrola_posledniho_zaznamu("rent_schedule") = "No" Then
        Unload frmWait
        MsgBox " Konèím bez nahrání dat na server!", vbInformation
        Exit Sub
    End If
    
    aktivni_list = ActiveSheet.Name()
    Call komentare_nahraj
    If kontrola_komentare_nahraj = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    'jak budu ukladat vic dat tak abych nebral duplicity... toto maly sql dotazek doda spravne grady
    Dim rst As ADODB.Recordset
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT COUNT(`(unit)_unit_name`) 'pocet_promenych' FROM tenant_list WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list)"
    rst.Open sql, CN, adOpenStatic, adLockReadOnly
        pocet_radek_rst = rst(0).value
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing

'vlož do pamìti vše z tenantù (co se bude nahrávat) samo že z sql
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT `(unit)_unit_name`, `(tenant)_tenant_name`, `(tenant)_brand_name`, `(tenant)_tenant_category`, `(tenant)_unit_size_[sqm]`, `(tenant)_opening_date`, `(tenant)_contract_effectivity_date`, `(tenant)_contract_expiration_date`, `(rent)_abatements_end_date` FROM pilot.`tenant_list` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list)"
    
    'ještì se musí pøidat where a poslední záznam abych nenaèítal šílený seznam
    rst.Open sql, CN, adOpenStatic, adLockReadOnly
    ReDim inte3(1 To pocet_radek_rst) As tenant_kontrola 'vytvoøí poèet promìných až
    
    For J = 0 To pocet_radek_rst - 1
        For I = 0 To rst.Fields.Count - 1
            Select Case I + 1
                Case 1
                    inte3(J + 1).unit_name = rst(I).value 'ukladani do radku
                Case 2
                    inte3(J + 1).tenant_name = rst(I).value 'ukladani do radku
                Case 3
                    inte3(J + 1).brand_name = rst(I).value 'ukladani do radku
                Case 4
                    inte3(J + 1).tenant_category = rst(I).value 'ukladani do radku
                Case 5
                    inte3(J + 1).unit_size_sqm = rst(I).value  'ukladani do radku
                Case 6
                    inte3(J + 1).opening_date = rst(I).value  'ukladani do radku
                Case 7
                    inte3(J + 1).Contract_effectivity_date = rst(I).value  'ukladani do radku
                Case 8
                    inte3(J + 1).contract_expiration_date = rst(I).value  'ukladani do radku
                Case 9
                    inte3(J + 1).abatements_end_date = rst(I).value  'ukladani do radku
            End Select
        Next I
        rst.MoveNext
    Next J
    
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing

sloupce_celkem = Cells(2, Columns.Count).End(xlToLeft).Column 'možná udìlat usedrange

Do
    If Cells(2, sloupce_celkem) = "" Then
        sloupce_celkem = sloupce_celkem - 1
    Else
        Exit Do
    End If
Loop

ReDim inte4(1 To sloupce_celkem) As setrideni

'uložení názvu sloupcù a jejich pozic
For I = 1 To UBound(inte4)
    inte4(I).pozice_sl_excel = I
    '-------------------------------------------------kontrola, že žádný sloupec není pojmenovaný od 1 do 12ctky-------------------------------------------------
'        If IsNumeric(Cells(2, i)) = True And Cells(2, i) >= 1 And Cells(2, i) <= 12 Then
'            MsgBox "V reportu se vyskytuje sloupec s èíselnýn názvem od 1 až 12 v záhlaví." & vbNewLine & "Pro správnou funkcionalitu reportu,nemùže být takto sloupec nazván. Pøejmenujte ho a spuse makro znovu."
'            Cells(2, i).Select
'            Unload frmWait
'            Exit Sub
'        End If
    '/------------------------------------------------kontrola, že žádný sloupec není pojmenovaný od 1 do 12ctky-------------------------------------------------
    
' ---------------------------------------------------------- vytváøení hlavièek ---------------------------------------------------------------------------------
    inte4(I).nazev_sl = Cells(2, I)
    If Cells(2, I) = 1 Then
        oblast = Cells(1, I).Address()
        If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
            inte4(I).rok = Year(Now())
        ElseIf Cells(2, I) <> "TOTAL" Then
            inte4(I).rok = Range(oblast)
        End If
        prvni_leden = 1
    ElseIf prvni_leden = 1 Then
        Select Case Cells(2, I)
            Case 1
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 2
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 3
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 4
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 5
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 6
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 7
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 8
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 9
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 10
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 11
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
            Case 12
                inte4(I).nazev_sl = Cells(2, I)
                If Range(oblast) = "Current Year  [LC]" And Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Year(Now())
                ElseIf Cells(2, I) <> "TOTAL" Then
                    inte4(I).rok = Range(oblast)
                End If
        End Select
    End If
Next I
' /--------------------------------------------------------- vytváøení hlavièek ---------------------------------------------------------------------------------


'zmìním názvy mìsícù na èísla
' ---------------------------------------------------------- doplnìní typu promìných z sql ---------------------------------------------------------------------
Set CN = New ADODB.Connection
CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
Set rst = New ADODB.Recordset
sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
rst.Open sql, CN, adOpenStatic

'ukládání sql promìných do mezipamìti
For J = 0 To rst.Fields.Count - 1
        nazvy_sloucu = nazvy_sloucu & ",`" & rst.Fields(J).Name & "`"
    For I = 1 To sloupce_celkem
      If rst.Fields(J).Name = inte4(I).nazev_sl Or (rst.Fields(J).Name = "Year" And inte4(I).nazev_sl = "1") Then
        inte4(I).pozice_sl_sql = J
        vyhodnoceni = inte4(I).pozice_sl_sql
        inte4(I).typ = rst.Fields(J).Type ' definice typu promìné
        Exit For
      End If
    Next I
    If vyhodnoceni = "" Or rst.Fields(J).Name <> "(system)_datum_cas_nahrani" Or rst.Fields(J).Name <> "(system)_nahrano_uctem" Or rst.Fields(J).Name <> "(system)_nahravano_verzi" Or rst.Fields(J).Name <> "(system)_radek" Or rst.Fields(J).Name <> "(system)_company" Or rst.Fields(J).Name <> "Year" Then
        Else
        MsgBox "Chybý sloupec """ & rst.Fields(J).Name & """ prosím vyexportujte si seznam ještì jednou nebo upravte nazpátek zmìny, které jste v názvech sloupcù udìlali." & vbNewLine & vbNewLine & "Bez správných názvù sloupcù se data neodešlou.", vbCritical
        Exit Sub
    End If
    vyhodnoceni = ""
Next J
' /--------------------------------------------------------- doplnìní typu promìných z sql ---------------------------------------------------------------------


    nazvy_sloucu = Mid(nazvy_sloucu, 2, Len(nazvy_sloucu) - 1)

'samoopravny kod, hlida abych mel doplnen vsechny casti ,dohrat do promenych na zbytek let pozice sql (pùvodnì se pøedpokládalo, že nebudou duplicity ve sloupcích - odlišeno rokem)
For I = 1 To sloupce_celkem
    If inte4(I).pozice_sl_sql <> 0 Then ' by mohlo dìlat v budoucnu problémy pac sql bere i pozici 0
        mesic = inte4(I).nazev_sl
        typ = inte4(I).typ
        temp_pozice = inte4(I).pozice_sl_sql
        If IsNumeric(mesic) = True Then
            For J = 1 To sloupce_celkem
                If inte4(J).pozice_sl_sql = 0 And inte4(J).nazev_sl = mesic Then
                    inte4(J).pozice_sl_sql = temp_pozice
                    inte4(J).typ = typ
                End If
            Next J
        End If
    End If
Next I

'rst.Close
 Set rs = Nothing
 CN.Close
 Set CN = Nothing

'kdy byla verze nahraná
verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

'zjisti poslední rok a odecti od nejstaršího, vysledek znasob na poctu mist?
For I = 1 To UBound(inte4)
    If nejvetsi_rok < inte4(I).rok Or nejvetsi_rok = "" Then
        nejvetsi_rok = inte4(I).rok
    End If
    
    If nejmensi_rok > inte4(I).rok Or nejmensi_rok = 0 Then
        If inte4(I).rok > 0 Then
            nejmensi_rok = inte4(I).rok
        End If
    End If
Next I

lr_puvodni = (Cells(Rows.Count, 4).End(xlUp).Row - 2)
lr = (Cells(Rows.Count, 3).End(xlUp).Row - 2) * (nejvetsi_rok - nejmensi_rok + 1) 'upravit aby tam byla chytrá podmínka (až budu definovat export tak nastavím)

ReDim inte2(1 To lr) As fin_hodnoty

For rocni_obdobi = nejmensi_rok To nejvetsi_rok

    If inte2_cislo = UBound(inte2) Then
        Exit For
    End If
    
    For r = 3 To Cells(Rows.Count, 2).End(xlUp).Row 'pøes všechny øádky najdi øetìžce
    If inte2_cislo = 159 Then
        a = a
    End If
        If Mid(((inte2_cislo) / lr_puvodni) * 10000, 2, 10000) = 0 And Len(Mid(((inte2_cislo) / lr_puvodni) * 10000, 2, 10000)) = 4 Then  'pokud dosáhneš na konec roèní øady, zaèni novou
            If vyhodnoceni_roku = 1 Then
                vyhodnoceni_roku = 0
            Else
                vyhodnoceni_roku = 1
                Exit For
            End If
        End If
        J = r - 1
    
    ' ------------------------------------ ukladani hodnot --------------------------------------------
    
        'do inte4 (sloupcovych hodnot, nahraju dalsi radek pro pripraveni exportu
        For s = 1 To sloupce_celkem
            If IsError(Cells(r, inte4(s).pozice_sl_excel)) = False Then
                If inte4(s).typ = 131 Then 'cislo
                    If IsNumeric(Cells(r, inte4(s).pozice_sl_excel)) = False Then
                        Cells(r, inte4(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Mid(Range(turnovers_tenant_odkaz).Address(1, 0), 1, InStr(Range(turnovers_tenant_odkaz).Address(1, 0), "$") - 1) & " mohou být pouze èísla." & vbNewLine & "Data v sloupci upravte a poté spuste znovu."
                        Unload frmWait
                        MsgBox " Konèím bez nahrání dat na server!", vbInformation
                        Exit Sub
                    ElseIf Cells(r, inte4(s).pozice_sl_excel) = "" Then
                        inte4(s).hodnota_radek = "'" & 0 & "'"
                    Else
                        inte4(s).hodnota_radek = "'" & Format(Cells(r, inte4(s).pozice_sl_excel) * 100, "#0") & "'"
                    End If
                ElseIf inte4(s).typ = 201 Then 'text
                    inte4(s).hodnota_radek = "'" & Cells(r, inte4(s).pozice_sl_excel) & "'"
                ElseIf inte4(s).typ = 133 Then 'datum
                    If IsNumeric(Format(Cells(r, inte4(s).pozice_sl_excel), "#0")) = True Or Cells(r, inte4(s).pozice_sl_excel) = "" Then
                        If Cells(r, inte4(s).pozice_sl_excel) = "" Then
                            inte4(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                        Else
                            inte4(s).hodnota_radek = "'" & Format(Cells(r, inte4(s).pozice_sl_excel), "YYYY-MM-DD") & "'"
                        End If
                    Else
                        Cells(r, inte4(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Cells(1, inte4(s).pozice_sl_excel) & " musí být datum nebo prázdné pole!" & vbNewLine & vbNewLine & "Data nenahrála na server, po opravì spuste proceduru znovu.", vbCritical
                        Exit Sub
                    End If
                End If
            ElseIf IsError(Cells(r, inte4(s).pozice_sl_excel)) = True Then
                If inte4(s).typ = 131 Then
                        inte4(s).hodnota_radek = "'" & 0 & "'"
                ElseIf inte4(s).typ = 201 Then
                    inte4(s).hodnota_radek = "''"
                ElseIf inte4(s).typ = 133 Then
                    inte4(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                End If
            End If
            
            If inte4(s).typ = 0 And inte4(s).pozice_sl_sql = 0 And inte4(s).hodnota_radek = "" Then
                inte4(s).hodnota_radek = "NEVKLADAT"
            Else
                inte4(s).hodnota_radek = Replace(inte4(s).hodnota_radek, ",", ".")
            End If
        Next
    ' /----------------------------------- ukladani hodnot --------------------------------------------
        
        
    ' -----------------------------kontrola na tenancy - nazev a unit ---------------------------------
        For s = 1 To sloupce_celkem
            If inte4(s).nazev_sl = "(tenant)_tenant_name" Then
                turnovers_tenant = inte4(s).hodnota_radek
                turnovers_tenant_odkaz = Cells(r, inte4(s).pozice_sl_excel).Address
                If turnovers_tenant <> "" And turnovers_unit <> "" Then Exit For
            End If
            
            If inte4(s).nazev_sl = "(unit)_unit_name" Then
                turnovers_unit = inte4(s).hodnota_radek
                If turnovers_tenant <> "" And turnovers_unit <> "" Then Exit For
            End If
        Next s
        
        turnovers_tenant = Replace(turnovers_tenant, "'", "")
        turnovers_unit = Replace(turnovers_unit, "'", "")
    ' /----------------------------kontrola na tenancy - nazev a unit ---------------------------------


        'radky inte3 - kontrola jestli se najde radek se spravnou kombinaci
        For I = 1 To UBound(inte3)
            If inte3(I).tenant_name = turnovers_tenant And inte3(I).unit_name = turnovers_unit Then
                kontrola_nazev = "ok"
                Exit For
            End If
        Next I
        
        'kontrola datumu
        For I = 1 To UBound(inte3)
            If inte3(I).abatements_end_date <> 0 Then
                If inte3(I).contract_expiration_date > inte3(I).opening_date And inte3(I).abatements_end_date > inte3(I).opening_date And inte3(I).abatements_end_date < Now Then
                    kontrola_datumy = "ok"
                    Exit For
                End If
            Else
                If inte3(I).contract_expiration_date > inte3(I).opening_date And inte3(I).contract_expiration_date > Now Then
                    kontrola_datumy = "ok"
                    Exit For
                End If
            End If
        Next I
        
        If kontrola_nazev <> "ok" Or kontrola_datumy <> "ok" Then
                Range(turnovers_tenant_odkaz).EntireRow.Select
                Select Case MsgBox("Název firmy " & turnovers_tenant & ", která užívá jednotku " & turnovers_unit & " není v seznamu tenantù. Turnovers by tedy nemìl obsahovat obrat za aktuální období." & vbNewLine & vbNewLine & "Pokud jste pøesvìdèeni o správnosti a jde pouze o špatný název nájemce (rozdíly v diakritice apod.), dejte ano v opaèném pøípadì dejte ne a nájemce nejdøíve pøidejte do seznamu tenantù. Poté znovu spuste.", vbYesNo)
                    Case vbNo
                        Unload frmWait
                        Exit Sub
                    Case vbYes
                       'Vyber_firmu.Show
                        MyVal = turnovers_tenant
                        Vyber_firmu.MyVariable MyVal
                        Vyber_firmu.Repaint
                        'zpetne rozklicovani
                        If turnovers_tenant <> turnovers_tenant2 Then
                            For I = 1 To UBound(inte3)
                                If InStr(1, turnovers_tenant2, inte3(I).tenant_name) > 0 Then
                                    Range(turnovers_tenant_odkaz) = inte3(I).tenant_name
                                    Range(turnovers_tenant_odkaz).Offset(0, -2) = inte3(I).unit_name
                                End If
                            Next I
                            'Range(turnovers_tenant_odkaz) = Mid(turnovers_tenant2, InStr(1, turnovers_tenant2, turnovers_tenant), Len(turnovers_tenant) + 1)
                        End If
                        
                        If Range(turnovers_tenant_odkaz) <> "" Then
                            MsgBox "Nájemce byl doplnìn, pro nahrání dat na server spuste upload znovu!"
                        End If
                        
                        turnovers_tenant2 = ""
                        Unload frmWait
                        MsgBox " Konèím bez nahrání dat na server!", vbInformation
                        Exit Sub
                        '/zpetne rozklicovani

'                        MyVal = turnovers_tenant
'                        Vyber_firmu.MyVariable MyVal
'                        Vyber_firmu(inte3.tenant_kontrola).Show
'                        End With
'                        Vyber_firmu.MyVariable tenant_kontrola
                End Select
'               MsgBox "Nemáte správnì název firmy " & turnovers_tenant & " , nebo nemáte k tenatovi pøiøazený správný unit kód " & turnovers_unit & "." & vbNewLine & "Firma se nedaøí dohledat v listu Tenantcy_schedule"
'               Unload frmWait
'               Exit Sub
        End If

        'vycisteni na dalsi cyklus
        kontrola_nazev = ""
        kontrola_datumy = ""
        turnovers_tenant = ""
        turnovers_unit = ""
        '/kontrola na tenant list jestli je vše jak má být
        
        
        For s = 1 To sloupce_celkem
        'kontrola ze nezapisuju stejne stejna cisla
            
            If akt_mesic = 12 Then
                akt_mesic = 0
                Exit For
            End If
            
            'musim pøidat cyklus, který po každém zapsání projede všechno znovu ... to vše :) a i si nechá v pamìti i po skonèení cyklu
            For iii = 1 To UBound(inte4)
               'If inte4(iii).rok <> 0 And rok_vyhodnoceni = 0 And inte4(iii).rok = rocni_obdobi Then
                If inte4(iii).rok = rocni_obdobi Then
                    rok_vyhodnoceni = inte4(iii).rok
                    If I <> "" Then Exit For
                End If
                
                If s = inte4(iii).pozice_sl_excel Or s = 3 Then ' beru od jednicky do .... srovnani dat stejne jako v sql
                'If s = inte4(iii).pozice_sl_sql Or s = 3 Then ' beru od jednicky do .... srovnani dat stejne jako v sql
                    If s = 3 Then
                        I = s
                        Exit For
                    Else
                        I = iii
                        Exit For
                    End If
                    If rok_vyhodnoceni <> 0 Then Exit For
                End If
            Next iii
            
            If I = "" Then
                If inte4(s).rok = rocni_obdobi Then 'ošetøení sloupce s rokem v sql - mohlo by dìlat potíže
                    I = inte4(s).pozice_sl_excel
                ElseIf inte4(s).rok <> rocni_obdobi Then
                    Exit For
                End If
            End If
            
            If inte4(I).hodnota_radek <> "NEVKLADAT" Then
                If inte4(I).pozice_sl_sql = 4 Then 'od ledna
                    If (rocni_obdobi - nejmensi_rok + 1) > 1 Then 'jde o první rok nebo je to již další rok?
                        Do
                            If inte4(I).rok = rocni_obdobi Then
                                Exit Do
                            Else
                                I = I + 1
                                If I >= UBound(inte4) Then
                                    Exit For
                                End If
                            End If
                        Loop
                        If akt_mesic = 0 Then
                            vysledny_retezec = vysledny_retezec & ",'" & inte4(I).rok & "'"
                            vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                            podminka_rok = inte4(I).rok
                            akt_mesic = 1
                        End If
                    Else 'jde o první rok
                        If akt_mesic = 0 Then
                            vysledny_retezec = vysledny_retezec & ",'" & inte4(I).rok & "'"
                            vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                            podminka_rok = inte4(I).rok
                            akt_mesic = 1
                        End If
                    End If
               Else
                    If inte4(I).rok <> 0 Or IsNumeric(inte4(I).nazev_sl) = True Then  'další rok, aktuální sloupec je již mìsíc
                        Do
                            If inte4(I).rok = rocni_obdobi And inte4(I).nazev_sl = akt_mesic + 1 Then
                                Exit Do
                            Else
                                I = I + 1
                            End If
                        Loop
                        vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                        akt_mesic = akt_mesic + 1
                    Else
                        vysledny_retezec = vysledny_retezec & "," & inte4(I).hodnota_radek
                    End If
               End If
            End If
            I = "" 'smazani promene
dalsi:
        Next
        akt_mesic = 0
        inte2_cislo = inte2_cislo + 1
        I = "" 'smazani promene
        rok_vyhodnoceni = 0
        
        If neukladej = 0 Then
            inte2(inte2_cislo).vysledny_retezec = vysledny_retezec & ",'0','" & verze & "','" & Environ("UserName") & "','" & Replace(Sheets("settings").Range("A3"), ",", ".") & "','" & "Laugaricio'"
            vysledny_retezec = ""
            
            'opravy pro vstup do sql
            inte2(inte2_cislo).vysledny_retezec = Mid(inte2(inte2_cislo).vysledny_retezec, 2, Len(inte2(inte2_cislo).vysledny_retezec) - 1)
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",,", ",',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",,", ",',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",',", ",'',")
            inte2(inte2_cislo).vysledny_retezec = Replace(inte2(inte2_cislo).vysledny_retezec, ",',", ",'',")

        End If
        neukladej = 0
        If inte2_cislo = 159 Then
            a = a
        End If
        
        If inte2_cislo >= UBound(inte2) Then
            Exit For
        End If
    Next
    
   'jestli jsou již všechny øádky vyøešené pak vyskoè
    If inte2_cislo = UBound(inte2) Then
        Exit For
    End If
vyhodnoceni_roku = 1
Next rocni_obdobi

For I = 1 To UBound(inte2)
    strsql = "INSERT INTO `pilot`.`rent_schedule` (" & nazvy_sloucu & ") VALUES (" & inte2(I).vysledny_retezec & ")"
    Set rs = CreateObject("ADODB.Recordset")
    Set CN = CreateObject("ADODB.Connection")
    CN.Open "DSN=test"
    rs.Open strsql, CN, adOpenStatic
   'rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
Next

hell:


'kontrola unit_name a tenant_name na tenant list kde bych mel najit vsechno s tenancy listem, kdyby ne dat msgbox a nechat rozhodnout
'to same udelat v excelu a zkontrolovat i duplicity aby tam nebyly

'u sqm koukat jestli se nepøidali nebo neubrali a upozornit na to.
'mít další promìnou na to, že to bylo nebo nebylo vyhodnoceno, (podmínky vstupu turnovers)
'pak složit seznam, nových a vyhozených firem?

'kontrola turnovers celkových metrù na tenant list

Unload frmWait
konec_sub = 0

End Sub

Private Sub rent_schedule_stahni_do_excelu()
Dim rst As ADODB.Recordset
Dim rok_min As Double, rok_max As Double

frmWait.Label2 = "Rent_schedule download process under way..."
frmWait.Show
frmWait.Repaint

Dim docasna_promena As uprava_dat
Dim I As Long

'If ActiveSheet.Name() <> "S5 Turnovers - epoxrt z SQL" Then
'    MsgBox "Jste na jiném listu než na" & vbNewLine & "S5 Turnovers - export z SQL" & vbNewLine & "prosím oznaète správný list a spuse proceduru znovu."
'Else

    'kontrola na pøipojení do sql
    Connect
    kontrola_verze
   'kontrola_posledniho_zaznamu ("Rent_Schedule")
    
    If kontrola_performance("cteni", "rent_schedule") = "No" Then
        Unload frmWait
        Exit Sub
    End If

    ActiveSheet.Cells.Clear
    '-definice roku
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT MAX(`year`) FROM pilot.`rent_schedule`;"
    rst.Open sql, CN, adOpenStatic

    If rst.EOF = True Then
      GoTo hell
    End If

    rok_max = rst(0).value

    rst.Close
    CN.Close
    Set CN = Nothing

    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    sql = "SELECT MIN(`year`) FROM pilot.`rent_schedule`;"
    rst.Open sql, CN, adOpenStatic
    
    If rst.EOF = True Then
      GoTo hell
    End If
    
    rok_min = rst(0).value
    
    rst.Close
    CN.Close
    Set CN = Nothing
    
    '/definice roku
    
'    'vypis pouze 3 roky
'    Do
'        If rok_min < rok_max - 2 Then
'            rok_min = rok_min + 1
'        Else
'            Exit Do
'        End If
'    Loop
    
    Select Case (rok_max - rok_min)

'    vos5 = vos4 + pocet_sloupcu
'    pocet_sloupcu = 0
'    sql_sloupce = ""
'
'    For j = 0 To rst.Fields.Count - 1
'        If IsNumeric(rst.Fields(j).Name) = True And InStr(1, rst.Fields(j).Name, "Year") = 0 Then
'            If vos5_rok = 0 Then vos5_rok = vos5
'            sql_sloupce = sql_sloupce & ",`" & rst.Fields(j).Name & "`"
'        End If
'    Next j

        Case Is = 5 'historie 5 let
            pripad = "6 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
           'sql_sloupce = sql_sloupce & ", '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`"
           'pocet_sloupcu = pocet_sloupcu + 1

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
                   'SELECT `(unit)_unit_name`,`(tenant)_unit_size_[sqm]`,`(tenant)_tenant_name`,'' `status`, '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`,`1`,`2`,`3`,`4`,`5`,`6`,`7`,`8`,`9`,`10`,`11`,`12` FROM pilot.`rent_schedule` WHERE `Year` = 2015 AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos5 = vos4 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos5_rok = 0 Then vos5_rok = vos5
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
        
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql5 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule`WHERE `Year` =" & rok_min + 4 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos6 = vos5 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos6_rok = 0 Then vos6_rok = vos6
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J

            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql6 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 5 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"

            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing

        Case Is = 4 'historie 5 let
            pripad = "5 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
'            sql_sloupce = sql_sloupce & ", '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`"
'            pocet_sloupcu = pocet_sloupcu + 1

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
                   'SELECT `(unit)_unit_name`,`(tenant)_unit_size_[sqm]`,`(tenant)_tenant_name`,'' `status`, '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`,`1`,`2`,`3`,`4`,`5`,`6`,`7`,`8`,`9`,`10`,`11`,`12` FROM pilot.`rent_schedule` WHERE `Year` = 2015 AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule`WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"

            vos5 = vos4 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
        
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos5_rok = 0 Then vos5_rok = vos5
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
        
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql5 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 4 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"

            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
            
        Case Is = 3 'historie 4 let
            pripad = "4 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
'            sql_sloupce = sql_sloupce & ", '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`"
'            pocet_sloupcu = pocet_sloupcu + 1

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
                   'SELECT `(unit)_unit_name`,`(tenant)_unit_size_[sqm]`,`(tenant)_tenant_name`,'' `status`, '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`,`1`,`2`,`3`,`4`,`5`,`6`,`7`,`8`,`9`,`10`,`11`,`12` FROM pilot.`rent_schedule` WHERE `Year` = 2015 AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 2 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            vos4 = vos3 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos4_rok = 0 Then vos4_rok = vos4
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql4 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 3 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
            
        Case Is = 2 'mám historii 3 let
            pripad = "3 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
'            sql_sloupce = sql_sloupce & ", '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`"
'            pocet_sloupcu = pocet_sloupcu + 1

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
                   'SELECT `(unit)_unit_name`,`(tenant)_unit_size_[sqm]`,`(tenant)_tenant_name`,'' `status`, '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`,`1`,`2`,`3`,`4`,`5`,`6`,`7`,`8`,`9`,`10`,`11`,`12` FROM pilot.`rent_schedule` WHERE `Year` = 2015 AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            vos3 = vos2 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    If vos3_rok = 0 Then vos3_rok = vos3
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql3 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_max & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
        Case Is = 1
            pripad = "2 roky"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM rent_schedule WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
'            sql_sloupce = sql_sloupce & ", '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`"
'            pocet_sloupcu = pocet_sloupcu + 1

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
                   'SELECT `(unit)_unit_name`,`(tenant)_unit_size_[sqm]`,`(tenant)_tenant_name`,'' `status`, '' `2015`,'' `2016`, '' `2017`,'' `2018`, '' `2019`, '' `2020`,'' `eff.rent`,`1`,`2`,`3`,`4`,`5`,`6`,`7`,`8`,`9`,`10`,`11`,`12` FROM pilot.`rent_schedule` WHERE `Year` = 2015 AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            vos2 = vos1 + pocet_sloupcu
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            For J = 0 To rst.Fields.Count - 1
                If IsNumeric(rst.Fields(J).Name) = True And InStr(1, rst.Fields(J).Name, "Year") = 0 Then
                    pocet_sloupcu = pocet_sloupcu + 1
                    If vos2_rok = 0 Then vos2_rok = pocet_sloupcu + vos2
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
            Next J
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql2 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` =" & rok_min + 1 & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"
            
            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
        Case Is = 0
            pripad = "1 rok"
            vos1 = 1 'vloží data do sloupce
            
            Set CN = New ADODB.Connection
            CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
            Set rst = New ADODB.Recordset
            sql = "SELECT * FROM turnovers WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
            rst.Open sql, CN, adOpenStatic
            
            'ukládání sql promìných do mezipamìti
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = False Then 'lnstr definuju co má system tak nebrat
                    pocet_sloupcu = pocet_sloupcu + 1
                    sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J

            For cyklus_rok = rok_min To rok_max
                sql_sloupce = sql_sloupce & ",'' `" & cyklus_rok & "`"
                pocet_sloupcu = pocet_sloupcu + 1
            Next
            
            sql_sloupce = sql_sloupce & ",'' `eff.rent`"
            pocet_sloupcu = pocet_sloupcu + 1
            
            For J = 0 To rst.Fields.Count - 1
                If InStr(1, rst.Fields(J).Name, "(system)") = 0 And InStr(1, rst.Fields(J).Name, "Year") = 0 And IsNumeric(rst.Fields(J).Name) = True Then  'lnstr definuju co má system tak nebrat
                    If Len(rst.Fields(J).Name) <= 2 Then
                        pocet_sloupcu = pocet_sloupcu + 1
                        sql_sloupce = sql_sloupce & ",`" & rst.Fields(J).Name & "`"
                    End If
                End If
                
                If IsNumeric(rst.Fields(J).Name) = True And vos1_rok = 0 Then
                    vos1_rok = pocet_sloupcu + (rok_max - rok_min) + 3
                End If
            Next J
            
            sql_sloupce = Mid(sql_sloupce, 2, Len(sql_sloupce) - 1)
            sql1 = "SELECT " & sql_sloupce & " FROM pilot.`rent_schedule` WHERE `Year` = " & rok_min & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`rent_schedule`);"

            pocet_sloupcu = 0
            sql_sloupce = ""
            
            rst.Close
            CN.Close
            Set CN = Nothing
    End Select

    If Mid(pripad, 1, 1) = 6 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_rent_to_sales_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_rent_to_sales_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_rent_to_sales_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
        Call download_rent_to_sales_into_sheet(sql5, vos5, vos5_rok, rok_min + 4, rok_max)
        Call download_rent_to_sales_into_sheet(sql6, vos6, vos6_rok, rok_min + 5, rok_max)
    ElseIf Mid(pripad, 1, 1) = 5 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_rent_to_sales_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_rent_to_sales_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_rent_to_sales_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
        Call download_rent_to_sales_into_sheet(sql5, vos5, vos5_rok, rok_min + 4, rok_max)
    ElseIf Mid(pripad, 1, 1) = 4 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_rent_to_sales_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_rent_to_sales_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
        Call download_rent_to_sales_into_sheet(sql4, vos4, vos4_rok, rok_min + 3, rok_max)
    ElseIf Mid(pripad, 1, 1) = 3 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_rent_to_sales_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
        Call download_rent_to_sales_into_sheet(sql3, vos3, vos3_rok, rok_min + 2, rok_max)
    ElseIf Mid(pripad, 1, 1) = 2 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
        Call download_rent_to_sales_into_sheet(sql2, vos2, vos2_rok, rok_min + 1, rok_max)
    ElseIf Mid(pripad, 1, 1) = 1 Then
        Call download_rent_to_sales_into_sheet(sql1, vos1, vos1_rok, rok_min, rok_max)
    End If

posledni_radek = Cells(Rows.Count, 3).End(xlUp).Row()
Do
    If Cells(posledni_radek, 3) = "" Then
        posledni_radek = posledni_radek - 1
    Else
        Exit Do
    End If
Loop

    pocet_roku = rok_max - rok_min + 1
    For rok_uprava = 1 To pocet_roku
        Cells(3, 3 + rok_uprava) = Format("=SUM(RC[" & 2 + (-12 + rok_uprava * 12) + pocet_roku - rok_uprava & "]:RC[" & 2 + (-12 + rok_uprava * 12) + pocet_roku - rok_uprava + 11 & "])", General)
        Cells(3, 3 + rok_uprava).Copy
        Range(Cells(3, 3 + rok_uprava), Cells(posledni_radek, 3 + rok_uprava)).PasteSpecial xlPasteFormulas
        Application.CutCopyMode = False
    Next
    
    For vzorec_radek = 3 To posledni_radek
        sloupec_hodnota = 5 + (rok_max - rok_min)
        vypoctovy_sloupec = sloupec_hodnota + 1
            Do
                If Cells(vzorec_radek, vypoctovy_sloupec) = 0 And vypoctovy_sloupec <= sloupec_hodnota + (12 * (rok_max - rok_min + 1)) Then
                    vypoctovy_sloupec = vypoctovy_sloupec + 1
                ElseIf vypoctovy_sloupec > sloupec_hodnota + (12 * (rok_max - rok_min + 1)) Then
                    vypoctovy_sloupec = sloupec_hodnota + 1
                    Exit Do
                Else
                    Exit Do
                End If
            Loop
        vypoctovy_sloupec_zprava = sloupec_hodnota + (12 * (rok_max - rok_min + 1))
            Do
                If (Cells(vzorec_radek, vypoctovy_sloupec_zprava) = "" Or Cells(vzorec_radek, vypoctovy_sloupec_zprava) = 0 Or ((Cells(vzorec_radek, vypoctovy_sloupec_zprava - 1) <> Cells(vzorec_radek, vypoctovy_sloupec_zprava)) And Cells(vzorec_radek, vypoctovy_sloupec_zprava + 1) = 0)) And vypoctovy_sloupec_zprava > vypoctovy_sloupec Then
                    vypoctovy_sloupec_zprava = vypoctovy_sloupec_zprava - 1
                Else
                    Exit Do
                End If
            Loop
       Cells(vzorec_radek, sloupec_hodnota) = Application.Average(Range(Cells(vzorec_radek, vypoctovy_sloupec), Cells(vzorec_radek, vypoctovy_sloupec_zprava)))
    Next
    

'-------------------------- vlozena cast -------------------------------------------------------------------------
posledni_bunka = Cells(Selection.SpecialCells(xlCellTypeLastCell).Row, ActiveCell.Cells().Column()).Address()
Set rnglast = Range(posledni_bunka).EntireRow.Rows.Find(What:="*", SearchOrder:=xlByRows, SearchDirection:=xlPrevious)
Do While rnglast Is Nothing
    posledni_bunka = Range(posledni_bunka).Offset(-1, 0).Address()
    Set rnglast = Range(posledni_bunka).EntireRow.Rows.Find(What:="*", SearchOrder:=xlByRows, SearchDirection:=xlPrevious)
Loop
Range(ActiveCell.Cells().Address(), Cells(Selection.SpecialCells(xlCellTypeLastCell).Row, ActiveCell.Cells().Column())).Select
'/------------------------- vlozena cast -------------------------------------------------------------------------

'End If
hell:

Call komentare_stahni_do_excelu

Unload frmWait
konec_sub = 0

'ReDim Preserve ArrayTest(UBound(ArrayTest) + 1)

End Sub

Sub komentare_nahraj()

Dim inte() As komentare_promena
Dim par As Worksheet
Dim inte2() As fin_hodnoty
kontrola_komentare_nahraj = ""
'For list = 1 To ThisWorkbook.Sheets.Count
'    If ThisWorkbook.Sheets(list).Visible = True Then
        Set par = ThisWorkbook.Sheets(aktivni_list)
        
        If par.Comments().Count > 0 Then
            ReDim inte(1 To par.Comments().Count) As komentare_promena 'poèet sloupcù v excelu
        
            '////////////////////////////do budoucna bude nahrazeno public promìnou a smažu cyklus //////////////////////////////////////////
            Select Case ActiveSheet.Name()
                Case "S3 Tenancy Schedule": radek_popisku = 1
                Case Else: radek_popisku = 2
            End Select
            
            
            For sloupec = 1 To Cells(radek_popisku, Columns.Count).End(xlToLeft).Column
                If Cells(radek_popisku, sloupec) = "(unit)_unit_name" Then
                    sloupec_unit = sloupec
                    Exit For
                End If
            Next
             
            For sloupec = 1 To Cells(radek_popisku, Columns.Count).End(xlToLeft).Column
                If Cells(radek_popisku, sloupec) = "(tenant)_tenant_name" Then
                    sloupec_tenant = sloupec
                    Exit For
                End If
            Next
            '////////////////////////////do budoucna bude nahrazeno public promìnou a smažu cyklus //////////////////////////////////////////
        
            For I = 1 To par.Comments().Count
                inte(I).bunka_adresa = Cells(par.Comments.Item(I).Parent.Cells.Row, par.Comments.Item(I).Parent.Cells.Column).Address(0, 0)
                inte(I).list = par.Name
                inte(I).komentare_text = Mid(par.Comments.Item(I).Shape.AlternativeText, InStr(1, par.Comments.Item(I).Shape.AlternativeText, ":") + 2, Len(par.Comments.Item(I).Shape.AlternativeText))
                If Len(inte(I).komentare_text) > 255 Then
                    Sheets(inte(I).list).Select
                    Range(inte(I).bunka_adresa).Select
                    MsgBox "Komentáø je pøíliš dlouhý, prosím zkrate ho na 255 znakù." & vbNewLine & vbNewLine & "Poté makro spuste znovu. Data se nenahrály." & vbNewLine & "Momentálnì komentáø obsahuje " & Len(inte(I).komentare_text) & " znakù."
                    kontrola_komentare_nahraj = "No"
                    Exit Sub
                End If
                inte(I).unit_name = Cells(par.Comments.Item(I).Parent.Cells.Row, sloupec_unit)
                inte(I).tenant_name = Cells(par.Comments.Item(I).Parent.Cells.Row, sloupec_tenant)
            Next
            
            ReDim inte2(1 To UBound(inte)) As fin_hodnoty 'poèet øádek
            
'            If verze = "" Then
'                verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")
'            End If
            
            For I = 1 To UBound(inte2)
                final_retezec = CistyText(LCase(inte(I).komentare_text))
                inte2(I).vysledny_retezec = "'0','" & final_retezec & "','" & inte(I).bunka_adresa & "','" & inte(I).unit_name & "','" & inte(I).tenant_name & "','" & Environ("UserName") & "','" & Sheets("settings").Range("A3") & "','" & verze & "','0000-00-00 00:00:00','" & inte(I).list & "'"
            Next
            
            For retezec = 1 To UBound(inte2)
                inte2(retezec).vysledny_retezec = Replace(inte2(retezec).vysledny_retezec, ",,", ",',")
                inte2(retezec).vysledny_retezec = Replace(inte2(retezec).vysledny_retezec, ",,", ",',")
                inte2(retezec).vysledny_retezec = Replace(inte2(retezec).vysledny_retezec, ",',", ",'',")
                inte2(retezec).vysledny_retezec = Replace(inte2(retezec).vysledny_retezec, ",',", ",'',")
            Next
            
            For I = 1 To UBound(inte2)
                strsql = "INSERT INTO `pilot`.`komentare` " & " VALUES (" & inte2(I).vysledny_retezec & ")"
                Set rs = CreateObject("ADODB.Recordset")
                Set CN = CreateObject("ADODB.Connection")
                CN.Open "DSN=test"
                rs.Open strsql, CN, adOpenStatic
               'rst.Close
                Set rs = Nothing
                CN.Close
                Set CN = Nothing
            Next
        
        End If
'    End If
'Next
End Sub

Sub komentare_stahni_do_excelu()
Dim yc As Range, c As Range
Dim inte() As komentare_promena
Dim par As Worksheet
Dim inte2() As fin_hodnoty

Set par = ThisWorkbook.ActiveSheet()

Select Case ThisWorkbook.ActiveSheet().Name()
    Case "S3 Tenancy Schedule"
        list_frontend = "tenant_list"
    Case "Rent Schedule"
        list_frontend = "rent_schedule"
    Case "S5 Turnovers"
        list_frontend = "turnovers"
End Select

'////////////////////////////////// smaz vsechny komentáøe ////////////////////////////////////////////////////////////////
If par.Comments().Count <> 0 Then
    For I = 1 To par.Comments().Count
        If yc Is Nothing Then
            Set yc = Cells(par.Comments.Item(I).Parent.Cells.Row, par.Comments.Item(I).Parent.Cells.Column)
        Else
            Set yc = Application.Union(yc, Cells(par.Comments.Item(I).Parent.Cells.Row, par.Comments.Item(I).Parent.Cells.Column))
        End If
    Next
    yc.ClearComments
End If
Set par = Nothing
'////////////////////////////////// smaz vsechny komentáøe ////////////////////////////////////////////////////////////////

'////////////////////////////// zjisti jestli máš komentáøe pro daný list /////////////////////////////////////////////////
Set rst = New ADODB.Recordset
rst.CursorLocation = adUseClient
Set CN = New ADODB.Connection
CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
sql = "SELECT COUNT(`(unit)_unit_name`) 'pocet_promenych' FROM komentare WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot." & list_frontend & ") AND `(system)_list` = '" & ActiveSheet.Name() & "';"
rst.Open sql, CN, adOpenStatic
    If rst.EOF = True Then
      GoTo hell
    End If
    pocet_komentaru = rst(0).value
rst.Close
Set rst = Nothing
CN.Close
Set CN = Nothing
'////////////////////////////// zjisti jestli máš komentáøe pro daný list /////////////////////////////////////////////////


'///////////////////////////zacni nahravat komentare /////////////////////////////////////////////////////////////////////
If pocet_komentaru > 0 Then
    ReDim inte(1 To pocet_komentaru) As komentare_promena
    
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    
    sql = "SELECT `bunka`,`(unit)_unit_name`,`(tenant)_tenant_name`,`komentare` FROM komentare WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot." & list_frontend & ") AND `(system)_list` = '" & ActiveSheet.Name() & "'"
    
    'MsgBox sql
    rst.Open sql, CN, adOpenStatic
    
    If rst.EOF = True Then
      GoTo hell
    End If
    
    For J = 0 To pocet_komentaru - 1
        For I = 0 To rst.Fields.Count - 1
            Select Case I + 1
                Case 1
                    inte(J + 1).bunka_adresa = rst(I).value
                Case 2
                    inte(J + 1).unit_name = rst(I).value 'ukladani do radku
                Case 3
                    inte(J + 1).tenant_name = rst(I).value 'ukladani do radku
                Case 4
                    inte(J + 1).komentare_text = rst(I).value 'ukladani do radku
            End Select
        Next I
        rst.MoveNext
    Next J
    
    '////////////////////////////do budoucna bude nahrazeno public promìnou a smažu cyklus //////////////////////////////////////////
    Select Case ActiveSheet.Name()
        Case "S3 Tenancy Schedule": radek_popisku = 1
        Case Else: radek_popisku = 2
    End Select
    
     For sloupec = 1 To Cells(radek_popisku, Columns.Count).End(xlToLeft).Column
         If Cells(radek_popisku, sloupec) = "(unit)_unit_name" Then
             sloupec_unit = sloupec
             Exit For
         End If
     Next
     
     For sloupec = 1 To Cells(radek_popisku, Columns.Count).End(xlToLeft).Column
         If Cells(radek_popisku, sloupec) = "(tenant)_tenant_name" Then
             sloupec_tenant = sloupec
             Exit For
         End If
     Next
    '////////////////////////////do budoucna bude nahrazeno public promìnou a smažu cyklus //////////////////////////////////////////
    
    
    For komentar_promena = 1 To UBound(inte)
        If Cells(Range(inte(komentar_promena).bunka_adresa).Row(), sloupec_unit) = inte(komentar_promena).unit_name Then
            unit = "ok"
        Else
            MsgBox "Chyba v zápisu tabulky komentáøù"
        End If
    
        If Cells(Range(inte(komentar_promena).bunka_adresa).Row(), sloupec_tenant) = inte(komentar_promena).tenant_name Then
            tenant = "ok"
        Else
            MsgBox "Chyba v zápisu tabulky komentáøù"
        End If
    
        If unit = "ok" And tenant = "ok" Then
            With Range(inte(komentar_promena).bunka_adresa)
                .AddComment
                With .Comment
                    .Visible = False
                    .Text Text:=inte(komentar_promena).komentare_text
                    With .Shape
                        With .TextFrame
                            .HorizontalAlignment = xlLeft
                            .VerticalAlignment = xlTop
                            .ReadingOrder = xlContext
                            .Orientation = msoTextOrientationHorizontal
                            .AutoSize = True
                        End With
                    End With
                End With
            End With
           'Range(inte(komentar_promena).bunka_adresa).Comment.Visible = False
           'Range(inte(komentar_promena).bunka_adresa).Comment.Text Text:=inte(komentar_promena).komentare_text
        End If
    Next
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
End If
hell:
End Sub


Sub uprava_komentaru()
    Dim MyVal As String
    MyVal = turnovers_tenant
    UserForm1.MyVariable_komentare MyVal
    UserForm1.Repaint
End Sub


Sub nahraj_faktury()

frmWait.Label2 = "Tenancy schedule update process under way..."
frmWait.Show
frmWait.Repaint

Dim Field As Field
Dim sloupec As Long
Dim radek As Long
Dim inte() As setrideni
Dim inte2() As fin_hodnoty
Dim sloupce_celkem As Long
Dim rst As ADODB.Recordset
Dim hodnota As String
Dim r As Integer 'radek
Dim s As Integer 'sloupce
Dim celkem_radku_dat As Integer 'poèet øádkù v databázi
Dim strsql As String

'kdy byla verze nahraná
verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

If ActiveSheet.Name() <> "issued invoices" Then
    MsgBox "Jste na jiném listu než na S3 Tenancy Schedule, prosím oznaète správný list a spuse proceduru znovu."
Else
    Connect
    kontrola_verze
    
    If kontrola_performance("zapis", "invoices") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    If kontrola_posledniho_zaznamu("invoices") = "No" Then
        Unload frmWait
        MsgBox " Konèím bez nahrání dat na server!", vbInformation
        Exit Sub
    End If
    
    aktivni_list = ActiveSheet.Name()
   'Call komentare_nahraj
    If kontrola_komentare_nahraj = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    sloupce_celkem = Cells(1, Columns.Count).End(xlToLeft).Column
    lr = Cells(Rows.Count, 2).End(xlUp).Row - 1
    
    ReDim inte(1 To sloupce_celkem) As setrideni 'poèet sloupcù v excelu
    ReDim inte2(1 To lr) As fin_hodnoty 'poèet øádek
    
    'uložení názvu sloupcù a jejich pozic
    For I = 1 To UBound(inte)
      inte(I).pozice_sl_excel = I
      inte(I).nazev_sl = Cells(1, I)
    Next I
    
    'propojení s sql
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    Set rst = New ADODB.Recordset
    sql = "SELECT * FROM invoices WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
    rst.Open sql, CN, adOpenStatic
    
    'ukládání sql promìných do mezipamìti
    For J = 0 To rst.Fields.Count - 1 ' j je sloupec v sql
        For I = 1 To sloupce_celkem 'i prezentuje sloupec excelu
          If rst.Fields(J).Name = inte(I).nazev_sl Then
            inte(I).pozice_sl_sql = J
            vyhodnoceni = "zapis"
            inte(I).typ = rst.Fields(J).Type
            Exit For
          End If
        Next I
        
        If vyhodnoceni = "" And rst.Fields(J).Name <> "(system)_datum_cas_nahrani" And rst.Fields(J).Name <> "(system)_nahrano_uctem" And rst.Fields(J).Name <> "(system)_nahravano_verzi" And rst.Fields(J).Name <> "(system)_company" And rst.Fields(J).Name <> "(system)_row" And rst.Fields(J).Name <> "(unit)_unit_name" And rst.Fields(J).Name <> "(tenant)_tenant_name" Then
            MsgBox "Chybý sloupec """ & rst.Fields(J).Name & """ prosím vyexportujte si seznam ještì jednou nebo upravte nazpátek zmìny, které jste v názvech sloupcù udìlali." & vbNewLine & vbNewLine & "Bez správných názvù sloupcù se data neodešlou.", vbCritical
            Unload frmWait
            Exit Sub
        End If
        vyhodnoceni = ""
    Next J
       
    'rst.Close
     Set rs = Nothing
     CN.Close
     Set CN = Nothing
    
    'seøazení sql dotazu pro insert - hlavièky sloupcù
    For I = 1 To sloupce_celkem - 1
        zahlavi = zahlavi & "," & inte(I).nazev_sl
    Next
    zahlavi = Mid(zahlavi, 2, Len(zahlavi) - 1)
    
    'naplnìní dat do promìných (po øádcích)
    For r = 2 To Cells(Rows.Count, 2).End(xlUp).Row
        J = r - 1

    ' ------------------------------------ uprava provedeni --------------------------------------------

        For s = 1 To sloupce_celkem
            If IsError(Cells(r, inte(s).pozice_sl_excel)) = False Then
                If inte(s).typ = 131 Then 'cislo
                    If Cells(r, inte(s).pozice_sl_excel) = "" Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                    ElseIf IsNumeric(Cells(r, inte(s).pozice_sl_excel)) = False Then
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox " Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " jsou textové hodnoty. Tento sloupec mùže obsahovat pouze èíselné hodnoty. Upravte podklad a puste nahrávání znovu." & vbNewLine & vbNewLine & "Data se nenahrála"
                        Unload frmWait
                        Exit Sub
                    Else
                        inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel) * 100, "#0") & "'"
                    End If
                ElseIf inte(s).typ = 201 Then 'text
                    inte(s).hodnota_radek = "'" & Cells(r, inte(s).pozice_sl_excel) & "'"
                ElseIf inte(s).typ = 133 Then 'datum
                    If IsNumeric(Format(Cells(r, inte(s).pozice_sl_excel), "#0")) = True Or Cells(r, inte(s).pozice_sl_excel) = "" Then
                        If Cells(r, inte(s).pozice_sl_excel) = "" Then
                            inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                        Else
                            inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel), "YYYY-MM-DD") & "'"
                        End If
                    Else
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " musí být datum nebo prázdné pole!" & vbNewLine & vbNewLine & "Data nenahrála na server, po opravì spuste proceduru znovu.", vbCritical
                        Unload frmWait
                        Exit Sub
                    End If
                End If
            ElseIf IsError(Cells(r, inte(s).pozice_sl_excel)) = True Then
                If inte(s).typ = 131 Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                ElseIf inte(s).typ = 201 Then
                    inte(s).hodnota_radek = "''"
                ElseIf inte(s).typ = 133 Then
                    inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                End If
            End If

            If inte(s).typ = 0 And inte(s).pozice_sl_sql = 0 And inte(s).hodnota_radek = "" Then
                inte(s).hodnota_radek = "NEVKLADAT"
            Else
                inte(s).hodnota_radek = Replace(inte(s).hodnota_radek, ",", ".")
            End If
        Next

        'složí to celé dohromady za øádku
        For s = 1 To sloupce_celkem
            If inte(s).hodnota_radek <> "NEVKLADAT" Then
                inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & "," & inte(s).hodnota_radek
            End If
        Next
        
        '//////////////////////////pøidìluje unit_name a tenant_name z tenancy !!! potøeba doladit o další položky/////////////////////////////////////////////////////////////
        
        'strsql = "SELECT `(unit)_unit_name`, MAX(`(system)_datum_cas_nahrani`) 'posledni_zaznam' FROM pilot.tenant_list WHERE `(tenant)_tenant_name` = " & CistyText2(inte(3).hodnota_radek) & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list) GROUP BY `(unit)_unit_name`;"
        strsql = "SELECT `(unit)_unit_name`, `(tenant)_tenant_name`, `(tenant)_brand_name`, `(tenant)_opening_date`, `(tenant)_contract_expiration_date`, MAX(`(system)_datum_cas_nahrani`) 'posledni_zaznam' FROM pilot.tenant_list WHERE `(tenant)_tenant_name` = " & inte(3).hodnota_radek & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list) GROUP BY `(unit)_unit_name`;"
       'strsql = "SELECT `(unit)_unit_name`, `(tenant)_tenant_name`, `(tenant)_brand_name`, `(tenant)_opening_date`, `(tenant)_contract_expiration_date`, MAX(`(system)_datum_cas_nahrani`) 'posledni_zaznam' FROM pilot.tenant_list WHERE `(tenant)_tenant_name` = " & CistyText2(inte(3).hodnota_radek) & " AND `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`) FROM pilot.tenant_list) GROUP BY `(unit)_unit_name`;"
        
'        '----------------------------------------------- verze s kontrolou na tenancy -------------------------------------------------------------------------
'        If pocet_radku_v_databazi(strsql) > 1 Then
'            MyVal = inte(3).hodnota_radek
'            vyber_jednotky.MyVariable MyVal 'zobrazi vyber - je potreba jeste dodat vrchni radku
'            vyber_jednotky.Repaint
'        ElseIf pocet_radku_v_databazi(strsql) = 0 Then
'            vyber_jednotky_promena = "''" 'není LT rent tedy nemá jednotku
'        Else
'            Set rs = CreateObject("ADODB.Recordset")
'            Set CN = CreateObject("ADODB.Connection")
'            CN.Open "DSN=test"
'            rs.Open strsql, CN, adOpenStatic
'                vyber_jednotky_promena = rs.Fields(0).value
'            Set rs = Nothing
'            CN.Close
'            Set CN = Nothing
'        End If
'        '/---------------------------------------------- verze s kontrolou na tenancy -------------------------------------------------------------------------
        
        inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & ",'0','" & "" & "'," & inte(3).hodnota_radek & ",'" & Environ("UserName") & "','" & Sheets("settings").Range("A5") & "','" & verze & "','" & Sheets("settings").Range("A3") & "'" 'verze bez kontroly na tenancy
       'inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & ",'0','" & vyber_jednotky_promena & "'," & inte(3).hodnota_radek & ",'" & Environ("UserName") & "','" & Sheets("settings").Range("A5") & "','" & verze & "'" 'verze bez kontroly na tenancy
       
       'inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & ",'0','" & vyber_jednotky_promena & "'," & inte(3).hodnota_radek & ",'" & Environ("UserName") & "','" & Sheets("settings").Range("A5") & "','" & verze & "'" 'verze s kontrolou na tenancy
        '& "','" & "','" & Replace(Sheets("settings").Range("A3"), ",", ".") & "','" & Sheets("settings").Range("A5") & "'"
        '- //////////////////////////pøidìluje unit_name a tenant_name z tenancy !!! potøeba doladit o další položky/////////////////////////////////////////////////////////////
        
        'opravy pro vstup do sql
        inte2(J).vysledny_retezec = Mid(inte2(J).vysledny_retezec, 2, Len(inte2(J).vysledny_retezec) - 1)
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
    Next

    For I = 1 To UBound(inte2)
        strsql = "INSERT INTO `pilot`.`invoices` " & " VALUES (" & inte2(I).vysledny_retezec & ")"
        Set rs = CreateObject("ADODB.Recordset")
        Set CN = CreateObject("ADODB.Connection")
        CN.Open "DSN=test"
        rs.Open strsql, CN, adOpenStatic
       'rst.Close
        Set rs = Nothing
        CN.Close
        Set CN = Nothing
    Next
End If

Unload frmWait
konec_sub = 0

End Sub


Private Sub stahni_do_excelu_faktury()
'Sheets("temp").Cells.Clear
frmWait.Label2 = "Tenancy schedule download process under way..."
frmWait.Show
frmWait.Repaint

Dim sloupce As Variant
Dim upravene_sloupce As Variant
Dim upravene_sloupce_temp As Variant
Dim upravene_sloupce_TS As Variant
Dim docasna_promena As uprava_dat
Dim I As Long

'If ActiveSheet.Name() <> "S3 TS - export z SQL" Then
'    MsgBox "Jste na jiném listu než na" & vbNewLine & "S3 TS - export z SQL" & vbNewLine & "prosím oznaète správný list a spuse proceduru znovu."
'Else
    
    'co to stahnout do tempu na extra list a pote to jednoduchym zpusobem upravit v bloku a teprve pa k to nakopirovat do spravneho excelu po jednotlivych sloupcich?
    'super napad lepsi a rychlejsi asi mit nebudu
    'co špatné seøazení? udìlat makro na seøazení stáhnutých dat (podle pùvodní èásti podle "unit_name" a "tenant_name"
    
    'kontrola na pøipojení do sql
    Connect
    kontrola_verze
    Call kontrola_performance("cteni", "invoices")
    
    If kontrola_performance("cteni", "invoices") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    kontrola_posledniho_zaznamu ("invoices")

    Dim rst As ADODB.Recordset
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    
'    sql = "SELECT `(unit)_unit_name`,`(tenant)_tenant_name`,`(tenant)_brand_name`,`(tenant)_tenant_category`,`(tenant)_covenant_Strenght`,`(tenant)_unit_size_[sqm]`,`(tenant)_opening_date`,`(tenant)_contract_effectivity_date`,`(tenant)_contract_expiration_date`,`(tenant)_lease_period`,`(tenant)_unexpired_lease_term_[mth]`,`(payment)_basic_rent_[sqm]/[mth]`,`(payment)_currecny`,`(payment)_frequency`,`(payment)_turnover_based_rent[%]`,`(rent)_actual_[sqm]/[mth]`,`(rent)_actual[mth]`,`(rent)_actual[annual]`,`(rent)_GRI[sqm]/[mth]`,`(rent)_GRI[mth]`,`(rent)_GRI[annual]`,`(rent)_rental_status`,`(rent)_comment_with_influence_on_the_rent_etc.`,`(rent)_all_comment_with_influence_on_the_rent_etc.`,`(rent)_abatements_disc_rent[sqm]`,`(rent)_abatements_start_date`,`(rent)_abatements_end_date`,`(rent)_abatements_period[mth]`,`(rent)_abatements_total_amount`,`(sch_&_marketing)_service_charges`,`(sch_&_marketing)_payment_currency`,`(sch_&_marketing)_sch_total`,`(sch_&_marketing)_marketing_charge`,`"
'    sql = sql & "(sch_&_marketing)2_payment_currency`,`(sch_&_marketing)_mch_Total`,`(indexation)_type_of_index`,`(indexation)_note`,`(indexation)_coeficient`,`(indexation)_date`,`(securities)_type`,`(securities)_amount_paid`,`(securities)_currency`,`(fit_out_contribution)_amount`,`(fit_out_contribution)_currency`,`(budget)_january`,`(budget)_february`,`(budget)_march`,`(budget)_april`,`(budget)_may`,`(budget)_june`,`(budget)_july`,`(budget)_august`,`(budget)_september`,`(budget)_october`,`(budget)_november`,`(budget)_december`,`(budget)_total` FROM pilot.`tenant_list` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`tenant_list`);"
    sql = "SELECT `porizovaci_cislo`,`datum pripadu`,`nazev_spolecnosti`,`popis_dodavky`,`castka bez dph`,`sazba_dph`,`mena`,`rada`,`nakladovy_okruh`,`cislo zakazky`,`splatnost` FROM pilot.`invoices` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`invoices`);"

    'MsgBox sql
    rst.Open sql, CN, adOpenStatic

    If rst.EOF = True Then
      GoTo hell
    End If

    For I = 0 To rst.Fields.Count - 1
        Sheets("Temp").Cells(1, I + 1).value = rst.Fields(I).Name
        If rst.Fields(I).Type = 133 Or rst.Fields(I).Type = 131 Or rst.Fields(I).Name = "(system)_datum_cas_nahrani" Or rst.Fields(I).Name <> "(system)_nahravano_verzi" Or rst.Fields(I).Name <> "(system)_company" Then  '133 datum, 131 cislo
            Set docasna_promena = New uprava_dat
            J = J + 1
            docasna_promena.sloupecID = "sloupec" & J
            docasna_promena.nazev_sloupce = rst.Fields(I).Name
            docasna_promena.typ_sloupce = rst.Fields(I).Type
            docasna_promena.cislo_sloupce = I + 1
            stala_promena.Add docasna_promena, docasna_promena.sloupecID
        End If
    Next I

    Sheets("issued invoices").Cells(2, 1).CopyFromRecordset rst

'-------------------------------- mega rychlostni uprava -----------------------------------------------------

    'pøidání desetiných míst pøes pamì
    ReDim upravene_sloupce(1 To rst.RecordCount, 0 To rst.Fields.Count - 1) As Variant 'poèet øádkù po úpravì

    For r = 1 To rst.RecordCount  'mohl bych nastavit na list ale když už je to v pamìti...
        For s = 0 To rst.Fields.Count - 1
            If stala_promena(s + 1).typ_sloupce = 131 Then 'cislo
                upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1) / 100  'podmínka vytvoøená pouze pro turnovers datumy zde nejsou
            ElseIf stala_promena(s + 1).typ_sloupce = 133 Then 'datum
                If Sheets("issued invoices").Cells(r + 1, s + 1) = 0 Then
                    upravene_sloupce(r, s) = ""
                    Sheets("issued invoices").Cells(r + 1, s + 1) = ""
                Else
                    upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1)
                End If
            Else
                upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1)
            End If
        Next s
    Next r
    
    Set TheRange = Range(Sheets("issued invoices").Cells(2, 1), Sheets("issued invoices").Cells(rst.RecordCount + 1, rst.Fields.Count))  'nastavení rozsahu upravovaných dat
    TheRange.value = upravene_sloupce 'hromadna uprava cisel (pres pamet)
    
    For I = 1 To stala_promena.Count 'úprava formátù
        If stala_promena(I).typ_sloupce = 131 Then
            If stala_promena(I).nazev_sloupce = "castka bez dph" Then
                Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0.00"
            Else
                Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0"
            End If
        ElseIf stala_promena(I).typ_sloupce = 133 Then
            Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "DD.MM.YYYY"
        End If
    Next
    
    'èištìní
    Erase upravene_sloupce
    Set docasna_promena = Nothing
    Set TheRange = Nothing
    ReDim upravene_sloupce_temp(1 To rst.RecordCount, 0 To 1) As Variant 'poèet øádkù po úpravì
    celkem_radek = rst.RecordCount
    celkem_sloupec = rst.Fields.Count
'/------------------------------- mega rychlostni uprava -----------------------------------------------------
    
    Set stala_promena = Nothing
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
'End If
hell:


Range("A1").Select

'Call komentare_stahni_do_excelu

Unload frmWait
konec_sub = 0
End Sub

Sub nahraj_platby()

frmWait.Label2 = "Tenancy schedule update process under way..."
frmWait.Show
frmWait.Repaint

Dim Field As Field
Dim sloupec As Long
Dim radek As Long
Dim inte() As setrideni
Dim inte2() As fin_hodnoty
Dim sloupce_celkem As Long
Dim rst As ADODB.Recordset
Dim hodnota As String
Dim r As Integer 'radek
Dim s As Integer 'sloupce
Dim celkem_radku_dat As Integer 'poèet øádkù v databázi
Dim strsql As String

'kdy byla verze nahraná
verze = Format(Now(), "YYYY-MM-DD") & " " & Format(Now(), "HH:MM:SS")

If ActiveSheet.Name() <> "platby" Then
    MsgBox "Jste na jiném listu než na platby, prosím oznaète správný list a spuse proceduru znovu."
Else
    Connect
    kontrola_verze
    
    If kontrola_performance("zapis", "payments") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    If kontrola_posledniho_zaznamu("payments") = "No" Then
        Unload frmWait
        MsgBox " Konèím bez nahrání dat na server!", vbInformation
        Exit Sub
    End If
    
    aktivni_list = ActiveSheet.Name()
   'Call komentare_nahraj
    If kontrola_komentare_nahraj = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    sloupce_celkem = Cells(1, Columns.Count).End(xlToLeft).Column
    lr = Cells(Rows.Count, 2).End(xlUp).Row - 1
    
    ReDim inte(1 To sloupce_celkem) As setrideni 'poèet sloupcù v excelu
    ReDim inte2(1 To lr) As fin_hodnoty 'poèet øádek
    
    'uložení názvu sloupcù a jejich pozic
    For I = 1 To UBound(inte)
      inte(I).pozice_sl_excel = I
      inte(I).nazev_sl = Cells(1, I)
    Next I
    
    'propojení s sql
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    Set rst = New ADODB.Recordset
    sql = "SELECT * FROM payments WHERE 'neexistujici sloupecek' = 'chci jen zahlavi sloupcu'"
    rst.Open sql, CN, adOpenStatic
    
    'ukládání sql promìných do mezipamìti
    For J = 0 To rst.Fields.Count - 1 ' j je sloupec v sql
        For I = 1 To sloupce_celkem 'i prezentuje sloupec excelu
          If rst.Fields(J).Name = inte(I).nazev_sl Then
            inte(I).pozice_sl_sql = J
            vyhodnoceni = "zapis"
            inte(I).typ = rst.Fields(J).Type
            Exit For
          End If
        Next I
        
        If vyhodnoceni = "" And rst.Fields(J).Name <> "(system)_datum_cas_nahrani" And rst.Fields(J).Name <> "(system)_nahrano_uctem" And rst.Fields(J).Name <> "(system)_nahravano_verzi" And rst.Fields(J).Name <> "(system)_company" And rst.Fields(J).Name <> "(system)_row" And rst.Fields(J).Name <> "(unit)_unit_name" And rst.Fields(J).Name <> "(tenant)_tenant_name" And rst.Fields(J).Name <> "castka_bez_dph" Then
            MsgBox "Chybý sloupec """ & rst.Fields(J).Name & """ prosím vyexportujte si seznam ještì jednou nebo upravte nazpátek zmìny, které jste v názvech sloupcù udìlali." & vbNewLine & vbNewLine & "Bez správných názvù sloupcù se data neodešlou.", vbCritical
            Unload frmWait
            Exit Sub
        End If
        vyhodnoceni = ""
    Next J
       
    'rst.Close
     Set rs = Nothing
     CN.Close
     Set CN = Nothing
    
    'seøazení sql dotazu pro insert - hlavièky sloupcù
    For I = 1 To sloupce_celkem - 1
        zahlavi = zahlavi & "," & inte(I).nazev_sl
    Next
    zahlavi = Mid(zahlavi, 2, Len(zahlavi) - 1)
    
    'naplnìní dat do promìných (po øádcích)
    For r = 2 To Cells(Rows.Count, 2).End(xlUp).Row
        J = r - 1

    ' ------------------------------------ uprava provedeni --------------------------------------------

        For s = 1 To sloupce_celkem
            If IsError(Cells(r, inte(s).pozice_sl_excel)) = False Then
                If inte(s).typ = 131 Then 'cislo
                    If Cells(r, inte(s).pozice_sl_excel) = "" Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                    ElseIf IsNumeric(Cells(r, inte(s).pozice_sl_excel)) = False Then
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox " Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " jsou textové hodnoty. Tento sloupec mùže obsahovat pouze èíselné hodnoty. Upravte podklad a puste nahrávání znovu." & vbNewLine & vbNewLine & "Data se nenahrála"
                        Unload frmWait
                        Exit Sub
                    Else
                        inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel) * 100, "#0") & "'"
                    End If
                ElseIf inte(s).typ = 201 Then 'text
                    inte(s).hodnota_radek = "'" & Cells(r, inte(s).pozice_sl_excel) & "'"
                ElseIf inte(s).typ = 133 Then 'datum
                    If IsNumeric(Format(Cells(r, inte(s).pozice_sl_excel), "#0")) = True Or Cells(r, inte(s).pozice_sl_excel) = "" Then
                        If Cells(r, inte(s).pozice_sl_excel) = "" Then
                            inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                        Else
                            inte(s).hodnota_radek = "'" & Format(Cells(r, inte(s).pozice_sl_excel), "YYYY-MM-DD") & "'"
                        End If
                    Else
                        Cells(r, inte(s).pozice_sl_excel).Select
                        MsgBox "Ve sloupci " & Split(Cells(r, inte(s).pozice_sl_excel).Address(1, 0), "$")(0) & " musí být datum nebo prázdné pole!" & vbNewLine & vbNewLine & "Data nenahrála na server, po opravì spuste proceduru znovu.", vbCritical
                        Unload frmWait
                        Exit Sub
                    End If
                End If
            ElseIf IsError(Cells(r, inte(s).pozice_sl_excel)) = True Then
                If inte(s).typ = 131 Then
                        inte(s).hodnota_radek = "'" & 0 & "'"
                ElseIf inte(s).typ = 201 Then
                    inte(s).hodnota_radek = "''"
                ElseIf inte(s).typ = 133 Then
                    inte(s).hodnota_radek = "'" & Format(0, "YYYY-MM-DD") & "'"
                End If
            End If

            If inte(s).typ = 0 And inte(s).pozice_sl_sql = 0 And inte(s).hodnota_radek = "" Then
                inte(s).hodnota_radek = "NEVKLADAT"
            Else
                inte(s).hodnota_radek = Replace(inte(s).hodnota_radek, ",", ".")
            End If
        Next

        'složí to celé dohromady za øádku
        For s = 1 To sloupce_celkem
            If inte(s).hodnota_radek <> "NEVKLADAT" Then
                inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & "," & smazat_vbnewline(inte(s).hodnota_radek)
            End If
        Next
        
        inte2(J).vysledny_retezec = inte2(J).vysledny_retezec & ",'0','" & "" & "'," & inte(3).hodnota_radek & ",'" & Environ("UserName") & "','" & Sheets("settings").Range("A5") & "','" & verze & "'" 'verze bez kontroly na tenancy
        
        'opravy pro vstup do sql
        inte2(J).vysledny_retezec = Mid(inte2(J).vysledny_retezec, 2, Len(inte2(J).vysledny_retezec) - 1)
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",,", ",',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
        inte2(J).vysledny_retezec = Replace(inte2(J).vysledny_retezec, ",',", ",'',")
    Next

    For I = 1 To UBound(inte2)
        strsql = "INSERT INTO `pilot`.`invoices` " & " VALUES (" & inte2(I).vysledny_retezec & ")"
        Set rs = CreateObject("ADODB.Recordset")
        Set CN = CreateObject("ADODB.Connection")
        CN.Open "DSN=test"
        rs.Open strsql, CN, adOpenStatic
       'rst.Close
        Set rs = Nothing
        CN.Close
        Set CN = Nothing
    Next
End If

Unload frmWait
konec_sub = 0

End Sub


Private Sub stahni_do_excelu_platby()
Sheets("temp").Cells.Clear
frmWait.Label2 = "Tenancy schedule download process under way..."
frmWait.Show
frmWait.Repaint

Dim sloupce As Variant
Dim upravene_sloupce As Variant
Dim upravene_sloupce_temp As Variant
Dim upravene_sloupce_TS As Variant
Dim docasna_promena As uprava_dat
Dim I As Long

'If ActiveSheet.Name() <> "S3 TS - export z SQL" Then
'    MsgBox "Jste na jiném listu než na" & vbNewLine & "S3 TS - export z SQL" & vbNewLine & "prosím oznaète správný list a spuse proceduru znovu."
'Else
    
    'co to stahnout do tempu na extra list a pote to jednoduchym zpusobem upravit v bloku a teprve pa k to nakopirovat do spravneho excelu po jednotlivych sloupcich?
    'super napad lepsi a rychlejsi asi mit nebudu
    'co špatné seøazení? udìlat makro na seøazení stáhnutých dat (podle pùvodní èásti podle "unit_name" a "tenant_name"
    
    'kontrola na pøipojení do sql
    Connect
    kontrola_verze
    Call kontrola_performance("cteni", "invoices")
    
    If kontrola_performance("cteni", "invoices") = "No" Then
        Unload frmWait
        Exit Sub
    End If
    
    kontrola_posledniho_zaznamu ("invoices")

    Dim rst As ADODB.Recordset
    Set rst = New ADODB.Recordset
    rst.CursorLocation = adUseClient
    Set CN = New ADODB.Connection
    CN.Open "DSN=test" 'do budoucna bude nutné øešit jinak
    
'    sql = "SELECT `(unit)_unit_name`,`(tenant)_tenant_name`,`(tenant)_brand_name`,`(tenant)_tenant_category`,`(tenant)_covenant_Strenght`,`(tenant)_unit_size_[sqm]`,`(tenant)_opening_date`,`(tenant)_contract_effectivity_date`,`(tenant)_contract_expiration_date`,`(tenant)_lease_period`,`(tenant)_unexpired_lease_term_[mth]`,`(payment)_basic_rent_[sqm]/[mth]`,`(payment)_currecny`,`(payment)_frequency`,`(payment)_turnover_based_rent[%]`,`(rent)_actual_[sqm]/[mth]`,`(rent)_actual[mth]`,`(rent)_actual[annual]`,`(rent)_GRI[sqm]/[mth]`,`(rent)_GRI[mth]`,`(rent)_GRI[annual]`,`(rent)_rental_status`,`(rent)_comment_with_influence_on_the_rent_etc.`,`(rent)_all_comment_with_influence_on_the_rent_etc.`,`(rent)_abatements_disc_rent[sqm]`,`(rent)_abatements_start_date`,`(rent)_abatements_end_date`,`(rent)_abatements_period[mth]`,`(rent)_abatements_total_amount`,`(sch_&_marketing)_service_charges`,`(sch_&_marketing)_payment_currency`,`(sch_&_marketing)_sch_total`,`(sch_&_marketing)_marketing_charge`,`"
'    sql = sql & "(sch_&_marketing)2_payment_currency`,`(sch_&_marketing)_mch_Total`,`(indexation)_type_of_index`,`(indexation)_note`,`(indexation)_coeficient`,`(indexation)_date`,`(securities)_type`,`(securities)_amount_paid`,`(securities)_currency`,`(fit_out_contribution)_amount`,`(fit_out_contribution)_currency`,`(budget)_january`,`(budget)_february`,`(budget)_march`,`(budget)_april`,`(budget)_may`,`(budget)_june`,`(budget)_july`,`(budget)_august`,`(budget)_september`,`(budget)_october`,`(budget)_november`,`(budget)_december`,`(budget)_total` FROM pilot.`tenant_list` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`tenant_list`);"
    sql = "SELECT `porizovaci_cislo`,`datum pripadu`,`nazev_spolecnosti`,`popis_dodavky`,`castka bez dph`,`sazba_dph`,`mena`,`rada`,`nakladovy_okruh`,`cislo zakazky`,`splatnost` FROM pilot.`invoices` WHERE `(system)_datum_cas_nahrani` = (SELECT MAX(`(system)_datum_cas_nahrani`)FROM pilot.`invoices`);"

    'MsgBox sql
    rst.Open sql, CN, adOpenStatic

    If rst.EOF = True Then
      GoTo hell
    End If

    For I = 0 To rst.Fields.Count - 1
        Sheets("Temp").Cells(1, I + 1).value = rst.Fields(I).Name
        If rst.Fields(I).Type = 133 Or rst.Fields(I).Type = 131 Or rst.Fields(I).Name = "(system)_datum_cas_nahrani" Or rst.Fields(I).Name <> "(system)_nahravano_verzi" Or rst.Fields(I).Name <> "(system)_company" Then  '133 datum, 131 cislo
            Set docasna_promena = New uprava_dat
            J = J + 1
            docasna_promena.sloupecID = "sloupec" & J
            docasna_promena.nazev_sloupce = rst.Fields(I).Name
            docasna_promena.typ_sloupce = rst.Fields(I).Type
            docasna_promena.cislo_sloupce = I + 1
            stala_promena.Add docasna_promena, docasna_promena.sloupecID
        End If
    Next I

    Sheets("issued invoices").Cells(2, 1).CopyFromRecordset rst

'-------------------------------- mega rychlostni uprava -----------------------------------------------------

    'pøidání desetiných míst pøes pamì
    ReDim upravene_sloupce(1 To rst.RecordCount, 0 To rst.Fields.Count - 1) As Variant 'poèet øádkù po úpravì

    For r = 1 To rst.RecordCount  'mohl bych nastavit na list ale když už je to v pamìti...
        For s = 0 To rst.Fields.Count - 1
            If stala_promena(s + 1).typ_sloupce = 131 Then 'cislo
                upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1) / 100  'podmínka vytvoøená pouze pro turnovers datumy zde nejsou
            ElseIf stala_promena(s + 1).typ_sloupce = 133 Then 'datum
                If Sheets("issued invoices").Cells(r + 1, s + 1) = 0 Then
                    upravene_sloupce(r, s) = ""
                    Sheets("issued invoices").Cells(r + 1, s + 1) = ""
                Else
                    upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1)
                End If
            Else
                upravene_sloupce(r, s) = Sheets("issued invoices").Cells(r + 1, s + 1)
            End If
        Next s
    Next r
    
    Set TheRange = Range(Sheets("issued invoices").Cells(2, 1), Sheets("issued invoices").Cells(rst.RecordCount + 1, rst.Fields.Count))  'nastavení rozsahu upravovaných dat
    TheRange.value = upravene_sloupce 'hromadna uprava cisel (pres pamet)
    
    For I = 1 To stala_promena.Count 'úprava formátù
        If stala_promena(I).typ_sloupce = 131 Then
            If stala_promena(I).nazev_sloupce = "castka bez dph" Then
                Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0.00"
            Else
                Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "#,##0"
            End If
        ElseIf stala_promena(I).typ_sloupce = 133 Then
            Range(Sheets("issued invoices").Cells(2, I), Sheets("issued invoices").Cells(rst.RecordCount + 2, I)).NumberFormat = "DD.MM.YYYY"
        End If
    Next
    
    'èištìní
    Erase upravene_sloupce
    Set docasna_promena = Nothing
    Set TheRange = Nothing
    ReDim upravene_sloupce_temp(1 To rst.RecordCount, 0 To 1) As Variant 'poèet øádkù po úpravì
    celkem_radek = rst.RecordCount
    celkem_sloupec = rst.Fields.Count
'/------------------------------- mega rychlostni uprava -----------------------------------------------------
    
    Set stala_promena = Nothing
    rst.Close
    Set rs = Nothing
    CN.Close
    Set CN = Nothing
'End If
hell:


Range("A1").Select

'Call komentare_stahni_do_excelu

Unload frmWait
konec_sub = 0
End Sub


